(function ($, Drupal) {
    'use strict';
    let initialized,
        someDataObj = {
            linkContents: "",
            linkAlt: "Profile menu",
            type: "default"
        };

    function init(settings) {
        if (!initialized) {
            initialized = true;
            // console.log(settings.user.uid + ', ' + window.location.hostname + ', ' + drupalSettings.rendering_server_hostname + ', ' + drupalSettings.is_rendering_server);
            handleUserBehavior(someDataObj, settings);
            displayView();
        }
    }

    Drupal.behaviors.ibm_carbon = {
        attach: function (context, settings) {
            init(settings);
        }
    };

})(jQuery, Drupal);

function handleUserBehavior(someDataObj, settings) {
    IBMCore.common.module.masthead.subscribe('profileMenuReady', 'customjs', function () {
        if (jQuery('#edit-openid-connect-client-generic-login').length) {
            /*if (drupalSettings.is_rendering_server) {
                // console.log('IBMCore.common.util.user.getInfo().signedin: ' + IBMCore.common.util.user.getInfo().signedin);
                if (IBMCore.common.util.user.getInfo().signedin) {
                    IBMCore.common.module.masthead.showProfileLinkSignedin(someDataObj);
                    jQuery('.ibm-profile-link').attr('data-widget', 'tooltip').attr('title', 'Sign Out').on('click', function (e) {
                        window.location.href = 'https://www.ibm.com/account/us-en/signout.html';
                    });
                } else {
                    IBMCore.common.module.masthead.showProfileLinkAnonymous(someDataObj);
                    jQuery('#edit-openid-connect-client-generic-login').remove();
                    jQuery('.ibm-profile-link').attr('data-widget', 'tooltip').attr('title', 'Sign In').on('click', function (e) {
                        e.preventDefault();
                        //window.location.href = 'https://idaas.iam.ibm.com/idaas/mtfim/sps/authsvc?PolicyId=urn:ibm:security:authentication:asf:basicldapuser&Target=' + window.location.href;
                        window.location.href = 'https://login.ibm.com/authsvc/mtfim/sps/authsvc?PolicyId=urn:ibm:security:authentication:asf:basicldapuser&Target=' + window.location.href;
                    });
                }
            } else {
                IBMCore.common.module.masthead.showProfileLinkAnonymous(someDataObj);
                jQuery('.ibm-profile-link').attr('data-widget', 'tooltip').attr('title', 'Sign In').on('click', function (e) {
                    e.preventDefault();
                    jQuery('#edit-openid-connect-client-generic-login').trigger('click');
                });
            }*/
        } else {
            IBMCore.common.module.masthead.showProfileLinkSignedin(someDataObj);
            jQuery('.ibm-profile-link').attr('data-widget', 'tooltip').attr('title', 'Sign Out').on('click', function (e) {
                e.preventDefault();
                utility.redirectToCustomLogoutPage();
            });
        }
        jQuery('.ibm-masthead-rightside').show();
    });
    // if (settings.user.uid === 0 && window.location.hostname != drupalSettings.rendering_server_hostname) {
    if (settings.user.uid === 0 && !drupalSettings.is_rendering_server) {
        utility.triggerCustomLogout();
    }
    if (window.location.href.indexOf("/revisions/") > -1) {jQuery('#block-ibm-carbon-page-title').show()}
    jQuery('table').wrap('<div style="overflow-x: auto"></div>');
}

function displayView() {
    dynamicIncludeJS();
    clickPrintIcon();
    fixShowHide();
    fixSubscribeLinkFormat();
    fixReferencesLinkFormat();
    fixGraphicTabs();
    applyOlClass();
    applyHeaderClass();
    modityEmptyContent();
    customPublishedUrlInView();
    customAparNumberInView();
    customProductAliasInView();
    customHistoricalNumberInView();
    customRelatedUrlInView();
    // displayFeedbackCommentOverlayHandler();
    displayDrupalFeedbackPageHandler();
    convertJsonToView('taxonomy');
    convertJsonToView('prerequisites');
    convertJsonToView('instructions');
    convertJsonToView('files');
    renderAttachmentHandler();
    initializeChat();
    prettyPrint();
    processATMBookmarks();
    ATMExpandCollapseAll();
    processMynPopupBehaviour();
    setTimeout(function () {
        // customTipView();
        //displayCarbonFullViewPageHandler();
        displayW3PassportAdvantageHandler();
        displayDownloadHandler();
        displayGeneralPageHandler();
        displaySecurityBulletHandler();
        displayInternalPage();
        renderingServerViewHandler();
        documentInformationHandler();
        displayProductsSupportDetailsLanding();
    }, 100);
    if (jQuery('#block-ibm-carbon-content').is(':hidden')) {
        jQuery('#ibm-nps-feedback-button').parents('.content').hide();
        displayAparHandler();  // #512
        jQuery('#block-ibm-carbon-content').show();
    }
}

function displayDrupalFeedbackPageHandler() {
    if (typeof drupalSettings.nid !== 'undefined' && drupalSettings.nid !== null) {
        let href = '';
        switch (getFeedbackFormName()) {
            case 'ibm-support-insider':
                href = '/feedback/support_insider_page_feedback/';
                break;
            case 'ibm-support-guide':
                href = '/feedback/support_guide_page_feedback/';
                break;
            default:
                href = '/feedback/page_feedback/';
        }
        href = location.href.indexOf('/support/pages/') != -1 ? '/support/pages' + href + drupalSettings.nid : href + drupalSettings.nid;
        // console.log(href);
        jQuery('#ibm-drupal-feedback').prop('href', href);
    }
    jQuery('#ibm-contact-module .ibm-requestquote-link').on('click', function (e) {
        e.preventDefault();
        jQuery('#ibm-drupal-feedback').trigger('click');
        jQuery('.ibm-close-link').trigger('click');
        var checkExist = setInterval(function() {
            if (jQuery('.ui-widget-content').length) {
                feedback.pageFeedbackLayoutHandler();
                feedback.charactersRemaining('drupal-modal', 'drupalFeedbackCommentCharactersRemaining', 1000);
                utility.makeModalDraggable();
                clearInterval(checkExist);
            }
        }, 100);
    });
    jQuery('.form-actions button.page-feedback-modal-form-btn-ok').on('click', function (e) {
        e.preventDefault();
        console.log('click!!');
        jQuery(document).one('ajaxStop', function () {
            jQuery('.ui-dialog button.ui-dialog-titlebar-close').trigger('click');
        });
    });
}

function displayAparHandler() {
    if (isViewModeFull('apar')) {
        var wordWrap = function (bigString, m, b) {
            var i, j, s, r = bigString.toString().split("\n");
            if (m > 0)
                for (i in r) {
                    for (s = r[i], r[i] = ""; s.length > m; j = (j = s.substr(0, m).match(/\S*$/)).input.length - j[0].length || m,
                        r[i] += s.substr(0, j) + ((s = s.substr(j)).length ? b : "")
                    );
                    r[i] += s;
                }
            return r.join("\n");
        };

        if (jQuery('[name=createForm]')[0] != null && jQuery('[name=createForm] h2').html().indexOf('Subscribe') != -1) {
            jQuery('#ibm-subscribe-section')
                .addClass('ibm-card')
                .append('<div class="ibm-card__content"></div>')
                .find('.ibm-card__content')
                .append(jQuery('[name=createForm]')[0])
                .find('input.ibm-btn-arrow-pri')
                .addClass('bx--btn')
                .addClass('bx--btn--secondary')
                .removeClass('ibm-btn-arrow-pri');
        }

        if (jQuery('#com\\.dblue\\.docview\\.body\\.content .field--name-field-content h2.ibm-first').text().trim().indexOf('Subscribe to this APAR') != -1) {
            jQuery('#ibm-subscribe-section')
                .addClass('ibm-card')
                .append('<div class="ibm-card__content"></div>')
                .find('.ibm-card__content')
                .append(jQuery('#com\\.dblue\\.docview\\.body\\.content .field--name-field-content h2.ibm-first').parent()[0]);

            if (jQuery('#ibm-subscribe-section a')) {
                jQuery('#ibm-subscribe-section a').addClass('bx--btn').addClass('bx--btn--secondary').parent().addClass('ibm-button-link');
            }
        }

        jQuery('#com\\.dblue\\.docview\\.body\\.content h3').removeClass('ibm-h4 ibm-bold');
        removeEmptyH2();
    }
}

/*function displayCarbonFullViewPageHandler() {
    if (isViewModeFull('passport-advantage')) {
        jQuery('article.contextual-region').addClass('bx--col-lg-12');
    }
    if (isViewModeFull('homepage')) {
        jQuery('article.contextual-region').addClass('bx--col-lg-12');
    }
}*/

function displayW3PassportAdvantageHandler() {
    // displayToolbarHandler();
    if (isViewModeFull('w3-passport-advantage')) {
        // jQuery('#toolbar-administration').hide();
        // jQuery('#toolbar-administration, #block-ibm-northstar-local-tasks').hide();
        jQuery('#toolbar-administration, #block-ibm-carbon-local-tasks, #block-ibm-carbon-page-title').hide();
        jQuery('#ibm-com').removeAttr('style');
        jQuery('#ibm-drupal-block').html(jQuery('#block-ibm-carbon-content'));
        jQuery('#block-ibm-carbon-content').find('div').removeClass('content').removeClass('node__content');
    }
}

function documentInformationHandler() {
    if (isViewModeFull('w3-passport-advantage')) {
        jQuery('#ibm-document-information').hide();
    }
    customContactReferenceFileView();
}

function renderAttachmentHandler() {
    let a = {
        startPath: '/sites/default',
        appendPath: '/support/pages',
        tag: 'a',
        link: 'href'
    },
        img = {
            startPath: '/sites/default',
            appendPath: '/support/pages',
            tag: 'img',
            link: 'src'
        };
    if (isViewModeFull('datacase-q-a')) {
        //a.appendPath = 'https://w3-03.ibm.com/services/technology/datacase/primary/docs/scadocs';
        //img.appendPath = 'https://w3-03.ibm.com/services/technology/datacase/primary/docs/scadocs';
        a.appendPath = '/support/pages/datacase';
        img.appendPath = '/support/pages/datacase';
        sourceHandler(a);
        sourceHandler(img);
    } else {
        renderSourceHandler(a);
        renderSourceHandler(img);
    }
}

function renderSourceHandler(obj) {
    if (drupalSettings.is_rendering_server) {
        jQuery('#ibm-content-main ' + obj.tag).each(function () {
            let tmp = jQuery(this).attr(obj.link);
            if (typeof tmp !== 'undefined') {
                jQuery(this).attr(obj.link, tmp.startsWith(obj.startPath) ? obj.appendPath + tmp : tmp);
            }
        });
    }
}

function sourceHandler(obj) {
    jQuery('#block-ibm-carbon-content .node__content ' + obj.tag).each(function () {
        let tmp = jQuery(this).attr(obj.link);
        if (typeof tmp !== 'undefined' && !tmp.startsWith('http') && !tmp.startsWith('mailto') && tmp.indexOf(obj.startPath) == -1 && !tmp.match('/add/node')) {
            // console.log(tmp);
            if (isViewModeFull('datacase-q-a') && tmp.includes('/support/pages/system/files')) {
                jQuery(this).attr(obj.link, tmp.startsWith('/') ? tmp : '/' + tmp);
            } else {
                jQuery(this).attr(obj.link, tmp.startsWith('/') ? obj.appendPath + tmp : obj.appendPath + '/' + tmp);
            }
        }
    });
}

function renderingServerViewHandler() {
    if (drupalSettings.is_rendering_server) {
        jQuery('#ibm-content-main .messages__wrapper.layout-container').hide();
        jQuery('.field--name-field-internal-use-only').remove();
        /*if (isViewModeFull('homepage') || isViewModeTeaser('homepage')) {
            jQuery.getScript('/support/pages/themes/ibm_carbon/js/supportmenu.jquery.js');
        }*/
        if (isViewModeFull('homepage') || isViewModeFull('w3-passport-advantage') || isViewModeTeaser('homepage')) {
            jQuery('#block-ibm-carbon-page-title').hide();
            jQuery('#search-header-wrapper, #ibm-contact-module, .ibm-contact-widget-btn').remove();
        }
        if (!isViewModeTeaser('homepage')) {
            jQuery('#search-header-wrapper, #ibm-contact-module, .ibm-contact-widget-btn').show();
        }
    } else {
        jQuery('#ibm-content-main .messages__wrapper.layout-container').show();
        jQuery('#search-header-wrapper, #ibm-contact-module, .ibm-contact-widget-btn').show();
        jQuery('.field--name-field-internal-use-only').show();
    }
}

// ibm-contact-module begin
function displayFeedbackCommentOverlayHandler() {
    createFeedbackToIBMSupportOverlaySection('divOverlayFeedbackToIBMSupport');
    jQuery('#ibm-contact-module .ibm-requestquote-link').on('click', function (e) {
        e.preventDefault();
        jQuery('#ibm-submit-support-feedback-form').attr('disabled', 'disabled');
        jQuery('.ibm-close-link').trigger('click');
        displayFeedbackComment();
    });
}

function enableFeedbackSubmit() {
    jQuery('#ibm-submit-support-feedback-form').removeAttr('disabled');
}

function displayFeedbackComment() {
    jQuery('#dynamic-feedback-to-ibm-support-form').trigger('reset');
    charactersRemaining('divOverlayFeedbackToIBMSupport', 'feedbackCommentCharactersRemaining', 1000);
    jQuery('.ibm-Feedback-To-IBM-Support-view-1').show();
    jQuery('.ibm-Feedback-To-IBM-Support-view-2, .ibm-Feedback-To-IBM-Support-view-3').hide();
    overlayHandler('divOverlayFeedbackToIBMSupport');
}

function overlayHandler(overlayName) {
    var openOverlay = IBMCore.common.widget.overlay.currentShowingOverlay();
    if (!openOverlay) {
        IBMCore.common.widget.overlay.show(overlayName);
    }
}

function backToIBMSupportFeedback() {
    jQuery('.ibm-Feedback-To-IBM-Support-view-3').hide();
    jQuery('.ibm-Feedback-To-IBM-Support-view-1').show();
}

function showAboutIBMSupportFeedback() {
    jQuery('.ibm-Feedback-To-IBM-Support-view-1').hide();
    jQuery('.ibm-Feedback-To-IBM-Support-view-3').show();
}

function showThankYouIBMSupportFeedback() {
    jQuery('.ibm-Feedback-To-IBM-Support-view-1').hide();
    jQuery('.ibm-Feedback-To-IBM-Support-view-2').show();
}

function charactersRemaining(overlayName, id, num) {
    jQuery('#' + id).html('Characters remaining: ' + num);
    jQuery('#' + overlayName + ' textarea').keyup(function () {
        var left = num - jQuery(this).val().length;
        if (left < 0) {
            left = 0;
        }
        jQuery('#' + id).html('Characters remaining: ' + left);
    });
}

function createFeedbackToIBMSupportOverlaySection(strOverlayName) {
    let feedbackToIBMSupportOverlay = IBMCore.common.widget.overlay.createOverlay({
        id: strOverlayName,
        classes: "ibm-common-overlay ibm-overlay-alt",
        contentHtml: createNewFeedback(getFeedbackFormName())
    });
    feedbackToIBMSupportOverlay.init();
}

function getFeedbackFormName() {
    return (typeof jQuery('#ibm-contact-module').attr('feedback') === 'undefined' ? 'ibm-dblue' : jQuery('#ibm-contact-module').attr('feedback').trim());
}

function createNewFeedback(name) {
    let feedbackFormContent,
        supportInsiderFeedbackFormContent = '<div class="ibm-Feedback-To-IBM-Support-view-1">' +
            '<h3 class="ibm-h4">IBM Support Insider Feedback</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<form class="ibm-styled ibm-row-form" method="post" id="dynamic-feedback-to-ibm-support-form" action="sendRatingComment();">' +
            '<input id="topicValue" value="SupportInsider" name="topicValue" type="hidden"/>' +
            '<p class="ibm-form-elem-grp" id="topic">' +
            '<select name="topicOption" id="topic_id" onchange="enableFeedbackSubmit();">' +
            '<option value="" selected="selected" disabled="disabled">Choose a topic for your comments</option>' +
            '<option id="topic1" value="Compliment">Compliment</option>' +
            '<option id="topic2" value="Content issue">Content issue</option>' +
            '<option id="topic3" value="Content suggestion">Content suggestion</option>' +
            '<option id="topic4" value="General comment">General comment</option>' +
            '<option id="topic5" value="Report broken link">Report broken link</option>' +
            '<option id="topic6" value="Website issue">Website issue</option>' +
            '</select>' +
            '<span class="ibm-required"> *</span></p>' +
            '<p><label for="comments" id="comments-label" style="display: none;">Rating Comments</label>' +
            '<textarea cols="56" rows="3" id="comments" name="comments" aria-labelledby="comments-label" placeholder="Click to begin"></textarea>' +
            '<span id="feedbackCommentCharactersRemaining" class="ibm-item-note ibm-right ibm-small ibm-bold">Characters remaining: 1000</span></p>' +
            '<p class="ibm-small ibm-bold">Providing your name and email will allow IBM to follow-up with you, if needed.</p>' +
            '<p><label for="name_id">Name:</label><span><input type="text" id="name_id" name="last_name" size="40"></span></p>' +
            '<p><label for="email_id">Email:</label><span><input type="text" id="email_id" name="email" size="40"></span></p>' +
            '<p id="country"><label for="UPDATE_Country_region_id">Country:</label><span id="countrySelector">' +
            '<select id="UPDATE_Country_region_id" name="usercc">' +
            '<option disabled="disabled" value="">Please select one</option>' +
            '<option value="United States" selected="selected">United States</option>' +
            '<option value="Argentina">Argentina</option>' +
            '<option value="Australia">Australia</option>' +
            '<option value="Austria">Austria</option>' +
            '<option value="Bahamas">Bahamas</option>' +
            '<option value="Bahrain">Bahrain</option>' +
            '<option value="Barbados">Barbados</option>' +
            '<option value="Belgium">Belgium</option>' +
            '<option value="Bermuda">Bermuda</option>' +
            '<option value="Bolivia">Bolivia</option>' +
            '<option value="Botswana">Botswana</option>' +
            '<option value="Brazil">Brazil</option>' +
            '<option value="Bulgaria">Bulgaria</option>' +
            '<option value="Canada">Canada</option>' +
            '<option value="Chile">Chile</option>' +
            '<option value="China">China</option>' +
            '<option value="Colombia">Colombia</option>' +
            '<option value="Croatia">Croatia</option>' +
            '<option value="Cyprus">Cyprus</option>' +
            '<option value="Czech Republic">Czech Republic</option>' +
            '<option value="Denmark">Denmark</option>' +
            '<option value="Dominican Republic">Dominican Republic</option>' +
            '<option value="Ecuador">Ecuador</option>' +
            '<option value="Egypt">Egypt</option>' +
            '<option value="El Salvador">El Salvador</option>' +
            '<option value="Estonia">Estonia</option>' +
            '<option value="Finland">Finland</option>' +
            '<option value="France">France</option>' +
            '<option value="Germany">Germany</option>' +
            '<option value="Greece">Greece</option>' +
            '<option value="Guatemala">Guatemala</option>' +
            '<option value="Honduras">Honduras</option>' +
            '<option value="Hong Kong S.A.R. of China">Hong Kong S.A.R. of China</option>' +
            '<option value="Hungary">Hungary</option>' +
            '<option value="India">India</option>' +
            '<option value="Indonesia">Indonesia</option>' +
            '<option value="Ireland">Ireland</option>' +
            '<option value="Israel">Israel</option>' +
            '<option value="Italy">Italy</option>' +
            '<option value="Jamaica">Jamaica</option>' +
            '<option value="Japan">Japan</option>' +
            '<option value="Jordan">Jordan</option>' +
            '<option value="Korea, Republic of">Korea, Republic of</option>' +
            '<option value="Kuwait">Kuwait</option>' +
            '<option value="Latvia">Latvia</option>' +
            '<option value="Latvia">Latvia</option>' +
            '<option value="Lithuania">Lithuania</option>' +
            '<option value="Malaysia">Malaysia</option>' +
            '<option value="Mexico">Mexico</option>' +
            '<option value="Morocco">Morocco</option>' +
            '<option value="Netherlands">Netherlands</option>' +
            '<option value="Netherlands Antilles">Netherlands Antilles</option>' +
            '<option value="New Zealand">New Zealand</option>' +
            '<option value="New Zealand">New Zealand</option>' +
            '<option value="Norway">Norway</option>' +
            '<option value="Oman">Oman</option>' +
            '<option value="Pakistan">Pakistan</option>' +
            '<option value="Panama">Panama</option>' +
            '<option value="Paraguay">Paraguay</option>' +
            '<option value="Peru">Peru</option>' +
            '<option value="Philippines">Philippines</option>' +
            '<option value="Poland">Poland</option>' +
            '<option value="Portugal">Portugal</option>' +
            '<option value="Qatar">Qatar</option>' +
            '<option value="Romania">Romania</option>' +
            '<option value="Russian Federation">Russian Federation</option>' +
            '<option value="Saudi Arabia">Saudi Arabia</option>' +
            '<option value="Senegal">Senegal</option>' +
            '<option value="Serbia and Montenegro">Serbia and Montenegro</option>' +
            '<option value="Singapore">Singapore</option>' +
            '<option value="Slovakia">Slovakia</option>' +
            '<option value="Slovenia">Slovenia</option>' +
            '<option value="South Africa">South Africa</option>' +
            '<option value="Spain">Spain</option>' +
            '<option value="Sri Lanka">Sri Lanka</option>' +
            '<option value="Suriname">Suriname</option>' +
            '<option value="Sweden">Sweden</option>' +
            '<option value="Switzerland">Switzerland</option>' +
            '<option value="Taiwan">Taiwan</option>' +
            '<option value="Thailand">Thailand</option>' +
            '<option value="Trinidad and Tobago">Trinidad and Tobago</option>' +
            '<option value="Tunisia">Tunisia</option>' +
            '<option value="Turkey">Turkey</option>' +
            '<option value="United Arab Emirates">United Arab Emirates</option>' +
            '<option value="United Kingdom">United Kingdom</option>' +
            '<option value="United States">United States</option>' +
            '<option value="Uruguay">Uruguay</option>' +
            '<option value="Venezuela">Venezuela</option>' +
            '<option value="Vietnam">Vietnam</option>' +
            '</select>' +
            '</span>' +
            '</p>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p><button class="ibm-btn-pri ibm-btn-blue-50 ibm-fright" id="ibm-submit-support-feedback-form" disabled onclick="javascript:sendFeedbackComment(); return false;" type="button" name="ibm-submit">Submit</button>' +
            '<a show-slide="about" class="ibm-powered-by-ol" href="javascript:void(0);" onclick="javascript:showAboutIBMSupportFeedback(); return false;">About feedback at IBM</a></p>' +
            '</form>' +
            '</div>' +
            '<!-- thanks card-->' +
            '<div class="ibm-Feedback-To-IBM-Support-view-2">' +
            '<h3 class="ibm-h4">IBM Support Insider Feedback</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p><strong>Thank you for taking the time to provide us with your feedback!</strong></p>' +
            '<p>IBM reviews all comments and will make every effort to take immediate action to improve your experience.</p>' +
            '</div>' +
            '<!-- thanks card-->' +
            '<div class="ibm-Feedback-To-IBM-Support-view-3">' +
            '<h3 class="ibm-h4">About ongoing feedback at IBM</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p>IBM collects opt-in feedback from IBM web users on a broad and continual basis ' +
            'throughout it\'s web sites. All feedback submitted are reviewed only by IBM employees or IBM affiliates and no feedback is shared outside ' +
            'of IBM for any reason. See IBM\'s ' +
            '<a href="http://www.ibm.com/privacy/us/en/?lnk=flg-priv-usen" target="_ibm_privacy_policy" data-action="close-overlay">privacy policy</a> and ' +
            '<a href="http://www.ibm.com/legal/us/en/?lnk=flg-tous-usen" data-action="close-overlay" target="_ibm_tou">terms of use</a> for more detail.</p>' +
            '<p>IBM may use a third party to collect or process feedback. Any such party is also bound by the IBM policy.</p>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p class="ibm-botton-link"><a class="ibm-btn-pri" href="javascript:void(0);" onclick="javascript:backToIBMSupportFeedback(); return false;">Back to Feedback</a></p>' +
            '</div>',
        supportGuideFeedbackFormContent = '<div class="ibm-Feedback-To-IBM-Support-view-1">' +
            '<h3 class="ibm-h4">IBM Support Guide Feedback</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<form class="ibm-styled ibm-row-form" method="post" id="dynamic-feedback-to-ibm-support-form" action="sendRatingComment();">' +
            '<input id="topicValue" value="SupportGuide" name="topicValue" type="hidden"/>' +
            '<p class="ibm-form-elem-grp" id="topic">' +
            '<select name="topicOption" id="topic_id" onchange="enableFeedbackSubmit();">' +
            '<option value="" selected="selected" disabled="disabled">Choose a topic for your comments</option>' +
            '<option id="topic1" value="Compliment">Compliment</option>' +
            '<option id="topic2" value="Content issue">Content issue</option>' +
            '<option id="topic3" value="General comment">General comment</option>' +
            '<option id="topic4" value="Report broken link">Report broken link</option>' +
            '<option id="topic5" value="Translation issue">Translation issue</option>' +
            '</select>' +
            '<span class="ibm-required"> *</span></p>' +
            '<p><label for="comments" id="comments-label" style="display: none;">Rating Comments</label>' +
            '<textarea cols="56" rows="3" id="comments" name="comments" aria-labelledby="comments-label" placeholder="Click to begin (comments optional)"></textarea>' +
            '<span id="feedbackCommentCharactersRemaining" class="ibm-item-note ibm-right ibm-small ibm-bold">Characters remaining: 1000</span></p>' +
            '<p class="ibm-small ibm-bold">Providing your name and email will allow IBM to follow-up with you, if needed.</p>' +
            '<p><label for="name_id">Name:</label><span><input type="text" id="name_id" name="last_name" size="40"></span></p>' +
            '<p><label for="email_id">Email:</label><span><input type="text" id="email_id" name="email" size="40"></span></p>' +
            '<p id="country"><label for="UPDATE_Country_region_id">Country:</label><span id="countrySelector">' +
            '<select id="UPDATE_Country_region_id" name="usercc">' +
            '<option disabled="disabled" value="">Please select one</option>' +
            '<option value="United States" selected="selected">United States</option>' +
            '<option value="Argentina">Argentina</option>' +
            '<option value="Australia">Australia</option>' +
            '<option value="Austria">Austria</option>' +
            '<option value="Bahamas">Bahamas</option>' +
            '<option value="Bahrain">Bahrain</option>' +
            '<option value="Barbados">Barbados</option>' +
            '<option value="Belgium">Belgium</option>' +
            '<option value="Bermuda">Bermuda</option>' +
            '<option value="Bolivia">Bolivia</option>' +
            '<option value="Botswana">Botswana</option>' +
            '<option value="Brazil">Brazil</option>' +
            '<option value="Bulgaria">Bulgaria</option>' +
            '<option value="Canada">Canada</option>' +
            '<option value="Chile">Chile</option>' +
            '<option value="China">China</option>' +
            '<option value="Colombia">Colombia</option>' +
            '<option value="Croatia">Croatia</option>' +
            '<option value="Cyprus">Cyprus</option>' +
            '<option value="Czech Republic">Czech Republic</option>' +
            '<option value="Denmark">Denmark</option>' +
            '<option value="Dominican Republic">Dominican Republic</option>' +
            '<option value="Ecuador">Ecuador</option>' +
            '<option value="Egypt">Egypt</option>' +
            '<option value="El Salvador">El Salvador</option>' +
            '<option value="Estonia">Estonia</option>' +
            '<option value="Finland">Finland</option>' +
            '<option value="France">France</option>' +
            '<option value="Germany">Germany</option>' +
            '<option value="Greece">Greece</option>' +
            '<option value="Guatemala">Guatemala</option>' +
            '<option value="Honduras">Honduras</option>' +
            '<option value="Hong Kong S.A.R. of China">Hong Kong S.A.R. of China</option>' +
            '<option value="Hungary">Hungary</option>' +
            '<option value="India">India</option>' +
            '<option value="Indonesia">Indonesia</option>' +
            '<option value="Ireland">Ireland</option>' +
            '<option value="Israel">Israel</option>' +
            '<option value="Italy">Italy</option>' +
            '<option value="Jamaica">Jamaica</option>' +
            '<option value="Japan">Japan</option>' +
            '<option value="Jordan">Jordan</option>' +
            '<option value="Korea, Republic of">Korea, Republic of</option>' +
            '<option value="Kuwait">Kuwait</option>' +
            '<option value="Latvia">Latvia</option>' +
            '<option value="Latvia">Latvia</option>' +
            '<option value="Lithuania">Lithuania</option>' +
            '<option value="Malaysia">Malaysia</option>' +
            '<option value="Mexico">Mexico</option>' +
            '<option value="Morocco">Morocco</option>' +
            '<option value="Netherlands">Netherlands</option>' +
            '<option value="Netherlands Antilles">Netherlands Antilles</option>' +
            '<option value="New Zealand">New Zealand</option>' +
            '<option value="New Zealand">New Zealand</option>' +
            '<option value="Norway">Norway</option>' +
            '<option value="Oman">Oman</option>' +
            '<option value="Pakistan">Pakistan</option>' +
            '<option value="Panama">Panama</option>' +
            '<option value="Paraguay">Paraguay</option>' +
            '<option value="Peru">Peru</option>' +
            '<option value="Philippines">Philippines</option>' +
            '<option value="Poland">Poland</option>' +
            '<option value="Portugal">Portugal</option>' +
            '<option value="Qatar">Qatar</option>' +
            '<option value="Romania">Romania</option>' +
            '<option value="Russian Federation">Russian Federation</option>' +
            '<option value="Saudi Arabia">Saudi Arabia</option>' +
            '<option value="Senegal">Senegal</option>' +
            '<option value="Serbia and Montenegro">Serbia and Montenegro</option>' +
            '<option value="Singapore">Singapore</option>' +
            '<option value="Slovakia">Slovakia</option>' +
            '<option value="Slovenia">Slovenia</option>' +
            '<option value="South Africa">South Africa</option>' +
            '<option value="Spain">Spain</option>' +
            '<option value="Sri Lanka">Sri Lanka</option>' +
            '<option value="Suriname">Suriname</option>' +
            '<option value="Sweden">Sweden</option>' +
            '<option value="Switzerland">Switzerland</option>' +
            '<option value="Taiwan">Taiwan</option>' +
            '<option value="Thailand">Thailand</option>' +
            '<option value="Trinidad and Tobago">Trinidad and Tobago</option>' +
            '<option value="Tunisia">Tunisia</option>' +
            '<option value="Turkey">Turkey</option>' +
            '<option value="United Arab Emirates">United Arab Emirates</option>' +
            '<option value="United Kingdom">United Kingdom</option>' +
            '<option value="United States">United States</option>' +
            '<option value="Uruguay">Uruguay</option>' +
            '<option value="Venezuela">Venezuela</option>' +
            '<option value="Vietnam">Vietnam</option>' +
            '</select>' +
            '</span>' +
            '</p>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p><button class="ibm-btn-pri ibm-btn-blue-50 ibm-fright" id="ibm-submit-support-feedback-form" disabled onclick="javascript:sendFeedbackComment(); return false;" type="button" name="ibm-submit">Submit</button>' +
            '<a show-slide="about" class="ibm-powered-by-ol" href="javascript:void(0);" onclick="javascript:showAboutIBMSupportFeedback(); return false;">About feedback at IBM</a></p>' +
            '</form>' +
            '</div>' +
            '<!-- thanks card-->' +
            '<div class="ibm-Feedback-To-IBM-Support-view-2">' +
            '<h3 class="ibm-h4">IBM Support Guide Feedback</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p><strong>Thank you for taking the time to provide us with your feedback!</strong></p>' +
            '<p>IBM reviews all comments and will make every effort to take immediate action to improve your experience.</p>' +
            '</div>' +
            '<!-- thanks card-->' +
            '<div class="ibm-Feedback-To-IBM-Support-view-3">' +
            '<h3 class="ibm-h4">About ongoing feedback at IBM</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p>IBM collects opt-in feedback from IBM web users on a broad and continual basis ' +
            'throughout it\'s web sites. All feedback submitted are reviewed only by IBM employees or IBM affiliates and no feedback is shared outside ' +
            'of IBM for any reason. See IBM\'s ' +
            '<a href="http://www.ibm.com/privacy/us/en/?lnk=flg-priv-usen" target="_ibm_privacy_policy" data-action="close-overlay">privacy policy</a> and ' +
            '<a href="http://www.ibm.com/legal/us/en/?lnk=flg-tous-usen" data-action="close-overlay" target="_ibm_tou">terms of use</a> for more detail.</p>' +
            '<p>IBM may use a third party to collect or process feedback. Any such party is also bound by the IBM policy.</p>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p class="ibm-botton-link"><a class="ibm-btn-pri" href="javascript:void(0);" onclick="javascript:backToIBMSupportFeedback(); return false;">Back to Feedback</a></p>' +
            '</div>',
        dblueFeedbackFormContent = '<div class="ibm-Feedback-To-IBM-Support-view-1">' +
            '<h3 class="ibm-h4">IBM Technical Support Feedback</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<form class="ibm-styled ibm-row-form" method="post" id="dynamic-feedback-to-ibm-support-form" action="sendRatingComment();">' +
            '<input id="topicValue" value="dBlue" name="topicValue" type="hidden"/>' +
            '<p class="ibm-form-elem-grp" id="topic">' +
            '<select name="topicOption" id="topic_id" onchange="enableFeedbackSubmit();">' +
            '<option value="" selected="selected" disabled="disabled">Choose a topic for your comments</option>' +
            '<option id="topic1" value="Broken link">Broken link</option>' +
            '<option id="topic2" value="Compliment">Compliment</option>' +
            '<option id="topic3" value="Content issue">Content issue</option>' +
            '<option id="topic4" value="Download failure">Download failure</option>' +
            '<option id="topic5" value="General comment">General comment</option>' +
            '<option id="topic6" value="Registration">Registration</option>' +
            '<option id="topic7" value="Search issue">Search issue</option>' +
            '<option id="topic8" value="Website issue">Website issue</option>' +
            '</select>' +
            '<span class="ibm-required"> *</span></p>' +
            '<p><label for="comments" id="comments-label" style="display: none;">Rating Comments</label>' +
            '<textarea cols="56" rows="3" id="comments" name="comments" aria-labelledby="comments-label" placeholder="Click to begin (comments optional)"></textarea>' +
            '<span id="feedbackCommentCharactersRemaining" class="ibm-item-note ibm-right ibm-small ibm-bold">Characters remaining: 1000</span></p>' +
            '<p class="ibm-small ibm-bold">Providing your name and email will allow IBM to follow-up with you, if needed.</p>' +
            '<p><label for="name_id">Name:</label><span><input type="text" id="name_id" name="last_name" size="40"></span></p>' +
            '<p><label for="email_id">Email:</label><span><input type="text" id="email_id" name="email" size="40"></span></p>' +
            '<p id="country"><label for="UPDATE_Country_region_id">Country:</label><span id="countrySelector">' +
            '<select id="UPDATE_Country_region_id" name="usercc">' +
            '<option disabled="disabled" value="">Please select one</option>' +
            '<option value="United States" selected="selected">United States</option>' +
            '<option value="Argentina">Argentina</option>' +
            '<option value="Australia">Australia</option>' +
            '<option value="Austria">Austria</option>' +
            '<option value="Bahamas">Bahamas</option>' +
            '<option value="Bahrain">Bahrain</option>' +
            '<option value="Barbados">Barbados</option>' +
            '<option value="Belgium">Belgium</option>' +
            '<option value="Bermuda">Bermuda</option>' +
            '<option value="Bolivia">Bolivia</option>' +
            '<option value="Botswana">Botswana</option>' +
            '<option value="Brazil">Brazil</option>' +
            '<option value="Bulgaria">Bulgaria</option>' +
            '<option value="Canada">Canada</option>' +
            '<option value="Chile">Chile</option>' +
            '<option value="China">China</option>' +
            '<option value="Colombia">Colombia</option>' +
            '<option value="Croatia">Croatia</option>' +
            '<option value="Cyprus">Cyprus</option>' +
            '<option value="Czech Republic">Czech Republic</option>' +
            '<option value="Denmark">Denmark</option>' +
            '<option value="Dominican Republic">Dominican Republic</option>' +
            '<option value="Ecuador">Ecuador</option>' +
            '<option value="Egypt">Egypt</option>' +
            '<option value="El Salvador">El Salvador</option>' +
            '<option value="Estonia">Estonia</option>' +
            '<option value="Finland">Finland</option>' +
            '<option value="France">France</option>' +
            '<option value="Germany">Germany</option>' +
            '<option value="Greece">Greece</option>' +
            '<option value="Guatemala">Guatemala</option>' +
            '<option value="Honduras">Honduras</option>' +
            '<option value="Hong Kong S.A.R. of China">Hong Kong S.A.R. of China</option>' +
            '<option value="Hungary">Hungary</option>' +
            '<option value="India">India</option>' +
            '<option value="Indonesia">Indonesia</option>' +
            '<option value="Ireland">Ireland</option>' +
            '<option value="Israel">Israel</option>' +
            '<option value="Italy">Italy</option>' +
            '<option value="Jamaica">Jamaica</option>' +
            '<option value="Japan">Japan</option>' +
            '<option value="Jordan">Jordan</option>' +
            '<option value="Korea, Republic of">Korea, Republic of</option>' +
            '<option value="Kuwait">Kuwait</option>' +
            '<option value="Latvia">Latvia</option>' +
            '<option value="Latvia">Latvia</option>' +
            '<option value="Lithuania">Lithuania</option>' +
            '<option value="Malaysia">Malaysia</option>' +
            '<option value="Mexico">Mexico</option>' +
            '<option value="Morocco">Morocco</option>' +
            '<option value="Netherlands">Netherlands</option>' +
            '<option value="Netherlands Antilles">Netherlands Antilles</option>' +
            '<option value="New Zealand">New Zealand</option>' +
            '<option value="New Zealand">New Zealand</option>' +
            '<option value="Norway">Norway</option>' +
            '<option value="Oman">Oman</option>' +
            '<option value="Pakistan">Pakistan</option>' +
            '<option value="Panama">Panama</option>' +
            '<option value="Paraguay">Paraguay</option>' +
            '<option value="Peru">Peru</option>' +
            '<option value="Philippines">Philippines</option>' +
            '<option value="Poland">Poland</option>' +
            '<option value="Portugal">Portugal</option>' +
            '<option value="Qatar">Qatar</option>' +
            '<option value="Romania">Romania</option>' +
            '<option value="Russian Federation">Russian Federation</option>' +
            '<option value="Saudi Arabia">Saudi Arabia</option>' +
            '<option value="Senegal">Senegal</option>' +
            '<option value="Serbia and Montenegro">Serbia and Montenegro</option>' +
            '<option value="Singapore">Singapore</option>' +
            '<option value="Slovakia">Slovakia</option>' +
            '<option value="Slovenia">Slovenia</option>' +
            '<option value="South Africa">South Africa</option>' +
            '<option value="Spain">Spain</option>' +
            '<option value="Sri Lanka">Sri Lanka</option>' +
            '<option value="Suriname">Suriname</option>' +
            '<option value="Sweden">Sweden</option>' +
            '<option value="Switzerland">Switzerland</option>' +
            '<option value="Taiwan">Taiwan</option>' +
            '<option value="Thailand">Thailand</option>' +
            '<option value="Trinidad and Tobago">Trinidad and Tobago</option>' +
            '<option value="Tunisia">Tunisia</option>' +
            '<option value="Turkey">Turkey</option>' +
            '<option value="United Arab Emirates">United Arab Emirates</option>' +
            '<option value="United Kingdom">United Kingdom</option>' +
            '<option value="United States">United States</option>' +
            '<option value="Uruguay">Uruguay</option>' +
            '<option value="Venezuela">Venezuela</option>' +
            '<option value="Vietnam">Vietnam</option>' +
            '</select>' +
            '</span>' +
            '</p>' +
            '<p id="techSupport">For technical support about IBM products, use <a target="_new" href="http://www.ibm.com/support/">IBM Support Portal</a>.</p>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p><button class="ibm-btn-pri ibm-btn-blue-50 ibm-fright" id="ibm-submit-support-feedback-form" disabled onclick="javascript:sendFeedbackComment(); return false;" type="button" name="ibm-submit">Submit</button>' +
            '<a show-slide="about" class="ibm-powered-by-ol" href="javascript:void(0);" onclick="javascript:showAboutIBMSupportFeedback(); return false;">About feedback at IBM</a></p>' +
            '</form>' +
            '</div>' +
            '<!-- thanks card-->' +
            '<div class="ibm-Feedback-To-IBM-Support-view-2">' +
            '<h3 class="ibm-h4">IBM Technical Support Feedback</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p><strong>Thank you for your feedback!</strong></p>' +
            '<p>IBM reviews all feedback. Not all comments will receive a response.<br/>All responses will be in English.</p>' +
            '</div>' +
            '<!-- thanks card-->' +
            '<div class="ibm-Feedback-To-IBM-Support-view-3">' +
            '<h3 class="ibm-h4">About ongoing feedback at IBM</h3>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p>IBM collects opt-in feedback from IBM web users on a broad and continual basis ' +
            'throughout it\'s web sites. All feedback submitted are reviewed only by IBM employees or IBM affiliates and no feedback is shared outside ' +
            'of IBM for any reason. See IBM\'s ' +
            '<a href="http://www.ibm.com/privacy/us/en/?lnk=flg-priv-usen" target="_ibm_privacy_policy" data-action="close-overlay">privacy policy</a> and ' +
            '<a href="http://www.ibm.com/legal/us/en/?lnk=flg-tous-usen" data-action="close-overlay" target="_ibm_tou">terms of use</a> for further detail.</p>' +
            '<div class="ibm-rule"><hr></div>' +
            '<p class="ibm-botton-link"><a class="ibm-btn-pri" href="javascript:void(0);" onclick="javascript:backToIBMSupportFeedback(); return false;">Back to Feedback</a></p>' +
            '</div>';
    // console.log(name);
    switch (name) {
        case 'ibm-support-insider':
            feedbackFormContent = supportInsiderFeedbackFormContent;
            break;
        case 'ibm-support-guide':
            feedbackFormContent = supportGuideFeedbackFormContent;
            break;
        default:
            feedbackFormContent = dblueFeedbackFormContent;
    }
    return feedbackFormContent;
}

function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function setCookie(name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    } else var expires = "";
    document.cookie = name + "=" + value + expires + "; path=/";
}

function deleteCookie(name) {
    setCookie(name, "", -1);
}

function sendFeedbackComment() {
    let queryString = jQuery('#dynamic-feedback-to-ibm-support-form').serialize(),
        locationHref = location.href.indexOf('/support/pages/node/') != -1 ? location.href : location.href.indexOf('/support/pages/') != -1 ? location.href.split('/support/pages/')[0] + '/support/pages/node/' + drupalSettings.nid : location.href,
        // locationHref = location.href.indexOf('/support/pages/node/') != -1 ? location.href : (typeof jQuery("link[rel='shortlink']").attr("href") !== 'undefined' && jQuery("link[rel='shortlink']").attr("href").indexOf('/support/pages/node/') != -1) ? jQuery("link[rel='shortlink']").attr("href") : (typeof jQuery("link[rel='shortlink']").attr("href") !== 'undefined' && jQuery("link[rel='canonical']").attr("href").indexOf('/support/pages/node/') != -1) ? jQuery("link[rel='canonical']").attr("href") : location.href,
        topic, topicOption, name, email, comments, usercc;

    if (queryString.indexOf("topicValue=") != -1) {
        topic = queryString.split("topicValue=")[1].split("&")[0].replace(/\+/g, ' ');
    }
    if (queryString.indexOf("topicOption=") != -1) {
        topicOption = queryString.split("topicOption=")[1].split("&")[0].replace(/\+/g, ' ');
    }
    if (queryString.indexOf("comments=") != -1) {
        comments = queryString.split("comments=")[1].split("&")[0];
    }
    if (queryString.indexOf("last_name=") != -1) {
        name = queryString.split("last_name=")[1].split("&")[0];
        if (name == "" || null == name) {
            name = "nobody";
        }
    }
    if (queryString.indexOf("email=") != -1) {
        email = queryString.split("email=")[1].split("&")[0];
        if (email == "" || null == email) {
            email = "nobody@nowhere.com";
        }
    }
    if (queryString.indexOf("usercc=") != -1) {
        usercc = queryString.split("usercc=")[1].split("&")[0].replace(/\+/g, ' ');
    } else {
        usercc = "United States";
    }

    // console.log("nid: " + drupalSettings.nid);
    // console.log("queryString: " + queryString);
    // console.log("topic: " + topic);
    // console.log("topicOption: " + topicOption);
    // console.log("Comments: " + comments);
    // console.log("Name: " + name);
    // console.log("Email: " + email);
    // console.log("Country: " + usercc);

    jQuery.ajaxSetup({
        scriptCharset: "utf-8",
        contentType: "application/javascript; charset=utf-8"
    });
    jQuery.ajax({
        // url: 'https://dbluewas1.pok.ibm.com/support/statuschecker.wss?action=getDrupalFeedbackCardToken',
        url: 'https://www-01.ibm.com/support/statuschecker.wss?action=getDrupalFeedbackCardToken',
        type: 'GET',
        dataType: 'jsonp',
        jsonpCallback: 'getTokenCallback',
        success: function (data) {
            if (data.hasOwnProperty('token')) {
                console.log(data.token);
                if (typeof topicOption !== 'undefined' && topicOption !== null && topicOption != "" && typeof topic !== 'undefined' && topic !== null && topic != "") {
                    let subject = jQuery('#divOverlayFeedbackToIBMSupport .ibm-Feedback-To-IBM-Support-view-1 h3').text().trim(),
                        content = '<topic>topic: ' + topic + '<br></topic>' +
                            '<topicOption>topic option: ' + topicOption + '<br></topicOption>' +
                            '<product>proudct: ' + IBMCore.common.meta.page.pageInfo.ibm.subject + '<br></product>' +
                            '<name>name: ' + name + '<br></name>' +
                            '<email>email: ' + email + '<br></email>' +
                            '<country>country: ' + usercc + '<br></country>' +
                            '<comments>comments: ' + comments + '<br><comments>' +
                            '<currentURL>currentURL: ';
                    jQuery.ajax({
                        // url: typeof data.token !== 'undefined' && data.token.length ? 'https://dbluewas1.pok.ibm.com/support/statuschecker.wss?action=drupalFeedbackCard&topic=' + topic + '&subject=' + subject + '&email=' + email + '&currentURL=' + encodeURIComponent(locationHref) + '&content=' + content + '&token=' + data.token : 'https://dbluewas1.pok.ibm.com/support/statuschecker.wss?action=drupalFeedbackCard&topic=' + topic + '&subject=' + subject + '&email=' + email + '&currentURL=' + encodeURIComponent(locationHref) + '&content=' + content,
                        url: typeof data.token !== 'undefined' && data.token.length ? 'https://www-01.ibm.com/support/statuschecker.wss?action=drupalFeedbackCard&topic=' + topic + '&subject=' + subject + '&email=' + email + '&currentURL=' + encodeURIComponent(locationHref) + '&content=' + content + '&token=' + data.token : 'https://www-01.ibm.com/support/statuschecker.wss?action=drupalFeedbackCard&topic=' + topic + '&subject=' + subject + '&email=' + email + '&currentURL=' + encodeURIComponent(locationHref) + '&content=' + content,
                        type: 'GET',
                        dataType: 'jsonp',
                        jsonpCallback: 'sendFeedbackCommentCallback',
                        success: function (data) {
                            if (data.hasOwnProperty('success')) {
                                console.log(data.success);
                            }
                        }
                    });
                }
            }
        }
    });
    showThankYouIBMSupportFeedback();
}
// ibm-contact-module end

function customTipView() {
    if (isTipViewMode()) {
        var arr = ['field--name-field-remediation-fixes', 'field--name-field-detail', 'field--name-field-workarounds-and-mitigation'];

        for (var i in arr) {
            jQuery('.' + arr[i] + ' p').each(function () {
                jQuery(this).html('<pre style="white-space: pre-wrap; word-wrap: break-word;">' + jQuery(this).html() + '</pre>');
            });
        }
    }
}

function customContactReferenceFileView() {
    if (isViewModeFull('contact-reference-file')) {
        jQuery('#ibm-document-information .field')
            .removeClass('field--type-datetime')
            .find('h2').addClass('ibm-h5').removeClass('ibm-h4');
    }
}

function dynamicIncludeJS() {
    jQuery("dcf").each(function () {
        //let href = '/sites/default/files/inline-files/dcf/js/' + jQuery(this).attr('src').split('/dcf/js/')[1];
        let href = '/sites/default/files/dcf/js/' + jQuery(this).attr('src').split('/dcf/js/')[1];
        href = location.href.indexOf('/support/pages/') != -1 ? '//' + location.hostname + '/support/pages' + href : '//' + location.hostname + href;
        // console.log(href);
        jQuery.getScript(href);
    });
}

function applyOlClass() {
    jQuery('ol[type]').each(function () {
        switch (jQuery(this).attr('type')) {
            case 'a':
                jQuery(this).addClass('ibm-alpha-list').removeAttr('type');
                break;
            case 'i':
                jQuery(this).addClass('ibm-roman-list').removeAttr('type');
                break;
            default:
                jQuery(this).removeAttr('type');
        }
    });
}

function applyHeaderClass() {
    jQuery('h2, h3').addClass('ibm-h4 ibm-bold');
    jQuery('#search-header-small').find('h3').removeClass('ibm-h4 ibm-bold');
}

function clickPrintIcon() {
    jQuery('.ibm-print-link').click(function (e) {
        e.preventDefault();
        window.print();
    });
}

function fixShowHide() {
    jQuery('ul.ibm-twisty').eq(0).attr('data-widget', 'twisty');
}

function fixReferencesLinkFormat() {
    // Change class ibm-external-link-alternate to ibm-external-link ibm-inlinelink ibm-icon-after
    jQuery('a.ibm-external-link-alternate').each(function () {
        jQuery(this).addClass('ibm-external-link').addClass('ibm-icon-after').addClass('ibm-inlinelink').removeClass('ibm-external-link-alternate');
    });
}

function fixSubscribeLinkFormat() {
    jQuery('p.ibm-information-link').each(function () {
        jQuery(this).addClass('ibm-icon-nolink').addClass('ibm-inlinelink');
    });
}

function fixGraphicTabs() {
    jQuery('.ibm-columns.ibm-graphic-tabs').removeClass('ibm-columns').each(function () {
        jQuery(this).find('.ibm-tabs').attr('role', 'tablist')
            .find('.ibm-last-tab a').attr('role', 'tab').attr('aria-selected', 'true')
            .find('.ibm-last-tab').addClass('ibm-highlight-tab').removeClass('ibm-last-tab');
    });
}

function removeEmptyH2() {
    jQuery('h2').each(function () {
        var jQuerythis = jQuery(this);

        if (jQuerythis.html().replace(/\s|&nbsp;/g, '').length == 0)
            jQuerythis.remove();
    });
}

function removeEmptyContent() {
    jQuery('p:empty').remove();
    // jQuery('p').each(function() {
    //     var jQuerythis = jQuery(this);
    //     if (jQuerythis.html().replace(/\s|&nbsp;/g, '').length == 0)
    //         jQuerythis.remove();
    // });
    jQuery('li').each(function () {
        var jQuerythis = jQuery(this);

        if (jQuerythis.html().replace(/\s|&nbsp;/g, '').length == 0)
            jQuerythis.remove();
    });
}

function modityEmptyContent() {
    jQuery('p:empty').remove();
    jQuery('div:not([id]):not([class]):empty').replaceWith('<br>');
    jQuery('div.field').each(function () {
        if (jQuery(this).html().trim().endsWith('</div>')) {
            jQuery(this).append('<br>');
        }
    });
}

function isViewModeFull(type) {
    return jQuery('article.node--view-mode-full').hasClass('node--type-' + type);
}

function isViewModeTeaser(type) {
    return jQuery('article.node--view-mode-teaser').hasClass('node--type-' + type);
}

function isTipViewMode() {
    var arr = ['system-tip', 'mcl-tip'];

    for (var i in arr) {
        if (isViewModeFull(arr[i])) {
            return true;
        }
    }
    return false;
}

function isQuestDataViewMode() {
    // Link, Product Documentation, Troubleshooting, Download, General Page, How to, Security Bulletin
    var arr = ['link', 'product-documentation', 'troubleshooting', 'download', 'general-page', 'how-to', 'security-bulletin'];

    for (var i in arr) {
        if (isViewModeFull(arr[i])) {
            return true;
        }
    }
    return false;
}

function isHardwareViewMode() {
    //disdev-902d return (jQuery('#taxonomy-source').text().length && jQuery('#taxonomy-source').text().indexOf('"Type":"HW"') != -1); 
    return (jQuery('#taxonomy-source').text().length && jQuery('#taxonomy-source').text().indexOf('"Type":"HW') != -1); //disdev-902a
}

function convertJsonToView(type) {
    switch (type) {
        case 'prerequisites':
            var objString = jQuery('#prerequistie-source').text().trim();

            if (objString.length > 2) {
                var jArr = JSON.parse(objString),
                    tableData = '<div class="dblue-table-container"><table class="bx--data-table" data-widget="datatable"><thead><tr>';

                tableData += '<th scope="col">URL</th>';
                tableData += '<th scope="col">LANGUAGE</th>';
                tableData += '<th scope="col">SIZE</th>';
                tableData += '</tr></thead><tbody>';

                for (var i in jArr) {
                    tableData += '<tr>';
                    if (typeof jArr[i]['PRLabel'] !== 'undefined' && jArr[i]['PRLabel'] !== null && jArr[i]['PRLabel'].length > 0) {
                        if (typeof jArr[i]['PRURL'] !== 'undefined' && jArr[i]['PRURL'] !== null && jArr[i]['PRURL'].trim().length > 0) {
                            tableData += '<td class="ibm-table-row" scope="row"><a href="' + jArr[i]['PRURL'] + '">' + jArr[i]['PRLabel'] + '</a></td>';
                        } else {
                            tableData += '<td class="ibm-table-row" scope="row">' + jArr[i]['PRLabel'] + '</td>';
                        }
                    } else {
                        tableData += '<td class="ibm-table-row" scope="row"></td>';
                    }
                    if (typeof jArr[i]['PRLang'] !== 'undefined' && jArr[i]['PRLang'] !== null && jArr[i]['PRLang'].length > 0) {
                        tableData += '<td>' + jArr[i]['PRLang'] + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    if (typeof jArr[i]['PRSize'] !== 'undefined' && jArr[i]['PRSize'] !== null && jArr[i]['PRSize'].length > 0) {
                        tableData += '<td>' + utility.appendUnit(jArr[i]['PRSize']) + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    tableData += '</tr>';
                };
                tableData += '</tbody></table></div>';

                if (!jQuery('.field--name-field-prerequisites h2').length) {
                    tableData = '<h2 class="ibm-h4 ibm-bold ibm-northstart-documentation-information-label">Prerequisites</h2>' + tableData;
                }

                jQuery("#prerequistie-table-list").addClass('ibm-padding-top-0').addClass('ibm-padding-bottom-1').html(tableData);
            }

            break;
        case 'instructions':
            var objString = jQuery('#instruction-source').text().trim();

            if (objString.length > 2) {
                var jArr = JSON.parse(objString),
                    tableData = '<div class="dblue-table-container"><table class="bx--data-table" data-widget="datatable"><thead><tr>';

                tableData += '<th scope="col">URL</th>';
                tableData += '<th scope="col">LANGUAGE</th>';
                tableData += '<th scope="col">SIZE</th>';
                tableData += '</tr></thead><tbody>';

                for (var i in jArr) {
                    tableData += '<tr>';
                    if (typeof jArr[i]['INLabel'] !== 'undefined' && jArr[i]['INLabel'] !== null && jArr[i]['INLabel'].length > 0) {
                        if (typeof jArr[i]['INURL'] !== 'undefined' && jArr[i]['INURL'] !== null && jArr[i]['INURL'].trim().length > 0) {
                            tableData += '<td class="ibm-table-row" scope="row"><a href="' + jArr[i]['INURL'] + '">' + jArr[i]['INLabel'] + '</a></td>';
                        } else {
                            tableData += '<td class="ibm-table-row" scope="row">' + jArr[i]['INLabel'] + '</td>';
                        }
                    } else {
                        tableData += '<td></td>';
                    }
                    if (typeof jArr[i]['INLang'] !== 'undefined' && jArr[i]['INLang'] !== null && jArr[i]['INLang'].length > 0) {
                        tableData += '<td>' + jArr[i]['INLang'] + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    if (typeof jArr[i]['INSize'] !== 'undefined' && jArr[i]['INSize'] !== null && jArr[i]['INSize'].length > 0) {
                        tableData += '<td>' + utility.appendUnit(jArr[i]['INSize']) + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    tableData += '</tr>';
                };
                tableData += '</tbody></table></div>';

                if (!jQuery('.field--name-field-instructions h2').length) {
                    tableData = '<h2 class="ibm-h4 ibm-bold ibm-northstart-documentation-information-label">Installation Instructions</h2>' + tableData;
                }

                jQuery("#instruction-table-list").addClass('ibm-padding-top-0').addClass('ibm-padding-bottom-1').html(tableData);
            }

            break;
        case 'files':
            var objString = jQuery('#file-source').text().trim(),
                useFC = (jQuery('#use-fix-central').text().trim() == 'On');

            if (objString.length > 2) {
                var jArr = JSON.parse(objString),
                    tableData = '<div class="dblue-table-container"><table class="bx--data-table" data-widget="datatable"><thead><tr>';

                tableData += '<th scope="col">Download</th>';
                tableData += '<th scope="col">RELEASE DATE</th>';
                tableData += '<th scope="col">LANGUAGE</th>';
                tableData += '<th scope="col">SIZE</th>';
                tableData += '<th scope="col">Download Options';
                if (useFC) {
                    tableData += '<br><a href="https://www.ibm.com/support/fixcentral/help?page=swfaqs">What is Fix Central(FC)?</a>';
                }
                tableData += '</th></tr></thead><tbody>';

                for (var i in jArr) {
                    tableData += '<tr>';
                    if (typeof jArr[i]['DNLabel'] !== 'undefined' && jArr[i]['DNLabel'] !== null && jArr[i]['DNLabel'].length > 0) {
                        tableData += '<td class="ibm-table-row" scope="row">' + jArr[i]['DNLabel'] + '</td>';
                    } else {
                        tableData += '<td class="ibm-table-row" scope="row"></td>';
                    }
                    if (typeof jArr[i]['DNDate'] !== 'undefined' && jArr[i]['DNDate'] !== null && jArr[i]['DNDate'].length > 0) {
                        tableData += '<td>' + jArr[i]['DNDate'] + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    if (typeof jArr[i]['DNLang'] !== 'undefined' && jArr[i]['DNLang'] !== null && jArr[i]['DNLang'].length > 0) {
                        tableData += '<td>' + jArr[i]['DNLang'] + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    if (typeof jArr[i]['DNSize'] !== 'undefined' && jArr[i]['DNSize'] !== null && jArr[i]['DNSize'].length > 0) {
                        tableData += '<td>' + utility.appendUnit(jArr[i]['DNSize']) + '</td>';
                    } else {
                        tableData += '<td></td>';
                    }
                    tableData += '<td>';
                    if (useFC) {
                        // FC
                        if (typeof jArr[i]['DNURL'] !== 'undefined' && jArr[i]['DNURL'] !== null && jArr[i]['DNURL'].trim().length > 0) {
                            tableData += '<a href="' + jArr[i]['DNURL'].trim() + '">FC</a> ';
                        }
                        if (typeof jArr[i]['DNURL_FTP'] !== 'undefined' && jArr[i]['DNURL_FTP'] !== null && jArr[i]['DNURL_FTP'].trim().length > 0) {
                            tableData += '<a href="' + jArr[i]['DNURL_FTP'] + '" onclick="return legalverify(this)">';
                            if (jArr[i]['DNURL_FTP'].toLowerCase().startsWith('ftp://')) {
                                tableData += 'FTP';
                            } else if (jArr[i]['DNURL_FTP'].toLowerCase().startsWith('ftps://')) {
                                tableData += 'FTPS';
                            } else if (jArr[i]['DNURL_FTP'].toLowerCase().startsWith('https://')) {
                                tableData += 'HTTPS';
                            } else {
                                tableData += 'HTTP';
                            }
                            tableData += '</a>';
                        }
                    } else {
                        // Pri
                        if (typeof jArr[i]['DNURL'] !== 'undefined' && jArr[i]['DNURL'] !== null && jArr[i]['DNURL'].trim().length > 0) {
                            tableData += '<a href="' + jArr[i]['DNURL'] + '" onclick="return legalverify(this)">';
                            if (jArr[i]['DNURL'].toLowerCase().startsWith('ftp://')) {
                                tableData += 'FTP';
                            } else if (jArr[i]['DNURL'].toLowerCase().startsWith('ftps://')) {
                                tableData += 'FTPS';
                            } else if (jArr[i]['DNURL'].toLowerCase().startsWith('https://')) {
                                tableData += 'HTTPS';
                            } else {
                                tableData += 'HTTP';
                            }
                            tableData += '</a> ';
                        }
                    }
                    tableData += '</td></tr>';
                };
                tableData += '</tbody></table></div>';
                jQuery('#field-download-package-title').html('<h2 class="ibm-h4 ibm-bold ibm-northstart-documentation-information-label">Download Package</h2>');
                jQuery("#file-table-list").addClass('ibm-padding-top-0').addClass('ibm-padding-bottom-1').html(tableData);
            }

            break;
        default:
            var objString = jQuery('#taxonomy-source').text().trim();

            if (objString.length > 2 && objString !== 'null') {
                // console.log("Document Information Taxonomy: " + objString);
                let jArr = JSON.parse(objString);

                if (jArr.length > 0) {
                    let armCategoryLabelArr = [],
                        platformLabelArr = [];

                    for (var j in jArr[0]['ARM Category']) {
                        armCategoryLabelArr[j] = jArr[0]['ARM Category'][j]['label'];
                    }
                    for (var j in jArr[0]['Platform']) {
                        platformLabelArr[j] = jArr[0]['Platform'][j]['label'];
                    }
                    platformLabelArr = jQuery.grep(platformLabelArr, function (value) {
                        return value !== 'Platform Independent' && value !== '';
                    });

                    var taxonomyInfoData = '<p>';

                    if (typeof jArr[0]['Product']['label'] !== 'undefined' && jArr[0]['Product']['label'] !== null && jArr[0]['Product']['label'].length > 0) {
                        taxonomyInfoData += '<strong>More support for: </strong><br>';
                        var topicID=getJsonTopicIdResponse('/support/pages/rest/taxonomy_object/get_csp_topic_id/'+jArr[0]['Product']['code']);
                        if(topicID){
                           taxonomyInfoData += '<a href="https://www.ibm.com/mysupport/s/topic/'+topicID+'" target="_blank">'+jArr[0]['Product']['label'] + '</a></p>';
                        } else {
                            taxonomyInfoData += jArr[0]['Product']['label'] + '</p>';
                        }
                        if(!isViewModeFull('apar') && drupalSettings.myn_subscription_url != ""){
                            var subscribe_html = '<div id="ibm-subscribe-section" class="ibm-card"><div class="ibm-card__content" style="padding-top: 20px!important;"><span>Manage My Notification Subscriptions</span><button class="bx--tooltip__trigger bx--tooltip--a11y bx--tooltip--left bx--tooltip--align-start" data-tooltip-icon=""><div class="bx--assistive-text" style="max-width:18rem;"><p>Click the <strong>Subscribe</strong> button to stay informed of critical IBM support updates with My Notifications.<br><br>Take a proactive approach to problem prevention.<br><br>Receive support content tailored to your needs, delivered directly to you!<br><br>Receive immediate notifications of Security Bulletins and Flashes.<br><br>Receive daily or weekly notifications of technical support information such as downloads, tips, technical notes, and publications.</p></div><svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true"><path d="M8.5 11L8.5 6.5 6.5 6.5 6.5 7.5 7.5 7.5 7.5 11 6 11 6 12 10 12 10 11zM8 3.5c-.4 0-.8.3-.8.8S7.6 5 8 5c.4 0 .8-.3.8-.8S8.4 3.5 8 3.5z"></path><path d="M8,15c-3.9,0-7-3.1-7-7s3.1-7,7-7s7,3.1,7,7S11.9,15,8,15z M8,2C4.7,2,2,4.7,2,8s2.7,6,6,6s6-2.7,6-6S11.3,2,8,2z"></path></svg></button><button id="myn_subscribe" class="bx--btn bx--btn--secondary" style="margin-top:20px;" type="button" data-modal-target="#modal-subscribe">Subscribe</button></div></div>';
                            var modal_subscribe_html='<div data-modal id="modal-subscribe" class="bx--modal " role="dialog" aria-modal="true" aria-labelledby="modal-subscribe-label" aria-describedby="modal-subscribe-heading" tabindex="-1"><div class="bx--modal-container bx--modal-container--xs"><div class="bx--modal-header"><p class="bx--modal-header__label bx--type-delta" id="modal-subscribe-label"></p><p class="bx--modal-header__heading bx--type-beta" id="modal-subscribe-heading"></p><button class="bx--modal-close" type="button" data-modal-close aria-label="close modal" id="myn_subscribe_modal_close"><svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" class="bx--modal-close__icon" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true"><path d="M12 4.7L11.3 4 8 7.3 4.7 4 4 4.7 7.3 8 4 11.3 4.7 12 8 8.7 11.3 12 12 11.3 8.7 8z"></path></svg></button></div><div class="bx--modal-content" tabindex="0"><p>You will be taken to the My Notifications interface where you have been auto-subscribed to <strong>'+ jArr[0]['Product']['label'] + '</strong></p><p>You can click the EDIT menu option to configure your subscription experience.</p><p>You can also search for and select other IBM products to subscribe to based on your needs.</p></div><div class="bx--modal-content--overflow-indicator"></div><div class="bx--modal-footer"><button class="bx--btn bx--btn--secondary" type="button" data-modal-close>Cancel</button><button id="myn_subscribe_submit" onclick="window.open(\'' + drupalSettings.myn_subscription_url + jArr[0]["Product"]["code"] + '\',\'_blank\');" class="bx--btn bx--btn--primary" type="button" data-modal-primary-focus>OK</button></div></div><span tabindex="0"></span></div>';
                            var isMyNEnabled=getJsonTopicIdResponse('/support/pages/rest/taxonomy_object/is_product_MyN_enabled/'+jArr[0]['Product']['code']);
                            if(isMyNEnabled==="1") {
                                jQuery('#ibm-document-information').after(subscribe_html);
                                jQuery('#ibm-document-information').after(modal_subscribe_html);
                            }
                            var button_element = document.getElementById("myn_subscribe");
                            if(typeof(button_element) != 'undefined' && button_element != null){
                                var uniqname = getUserLoggedStatus();
                                if(uniqname!==undefined || !drupalSettings.is_rendering_server){
                                } else {
                                    button_element.innerText = 'Log in to Subscribe';
                                    button_element.onclick = function (e){
                                        setCookie("shouldOpenMynPopup", "true", 1);
                                        document.querySelectorAll("dds-masthead-profile-item")[1].shadowRoot.children[0].click();
                                        e.stopImmediatePropagation();};
                                }
                            }
                            jQuery(document).on('click', '#myn_subscribe_submit', function(){jQuery("#modal-subscribe").removeClass('is-visible');});
                        }
                    }
                    if (typeof armCategoryLabelArr !== 'undefined' && armCategoryLabelArr !== null && armCategoryLabelArr.length > 0) {
                        taxonomyInfoData += '<p><strong>Component: </strong><br>';
                        // taxonomyInfoData += jArr[0]['Component'].toString().split(/\s*;\s*/).join(', ') + '</p>';
                        taxonomyInfoData += armCategoryLabelArr.join(', ') + '</p>';
                    }
                    if (typeof jArr[0]['Version'] !== 'undefined' && jArr[0]['Version'] !== null && jArr[0]['Version'].length > 0) {
                        taxonomyInfoData += '<p><strong>Software version: </strong><br>';
                        //disdev-951d taxonomyInfoData += jArr[0]['Version'].toString().split(/\s*;\s*/).join(', ') + '</p>';
                        //disdev-951a begin
                        var tmp_ver = jArr[0]['Version'].toString().split(/\s*;\s*/).join(', ');
                        tmp_ver = tmp_ver.replace(", and future releases", " and future releases");
                        taxonomyInfoData += tmp_ver + '</p>';
                        //disdev-951a end
                    }
                    if (platformLabelArr.join('; ').length > 0) {
                        taxonomyInfoData += '<p><strong>Operating system(s): </strong><br>';
                        taxonomyInfoData += platformLabelArr.join(', ') + '</p>';
                    }
                    // if (typeof jArr[0]['Edition'] !== 'undefined' && jArr[0]['Edition'] !== null && jArr[0]['Edition'].length > 0) {
                    //     taxonomyInfoData += '<p><strong>Software edition: </strong><br>';
                    //     taxonomyInfoData += jArr[0]['Edition'].toString().split(/\s*;\s*/).join(', ') + '</p>';
                    // }
                    if (typeof drupalSettings.nid !== 'undefined' && drupalSettings.nid !== null) {
                        taxonomyInfoData += '<p><strong>Document number: </strong><br>' + drupalSettings.nid + '</p>';
                    }
                    // if (jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().length > 0) {
                    //     taxonomyInfoData += '<p><strong>Reference #: </strong><br>';
                    //     if (jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().startsWith('ibm1')) {
                    //         taxonomyInfoData += jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().substr(4).replace(/\b(0+)/gi, "") + '</p>';
                    //     } else {
                    //         taxonomyInfoData += jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().substr(4) + '</p>';
                    //     }
                    // }
                    // console.log(taxonomyInfoData);
                    jQuery('#taxonomy-items').html(taxonomyInfoData);
                }

                if (jQuery('#products-list').length && jArr.length > 0) {
                    var first = true;
                    var result = '';
                    for (var i in jArr) {
                        if (typeof jArr[i]['Product']['label'] !== 'undefined' && jArr[i]['Product']['label'] !== null) {
                            var sep = first ? '' : ', ';
                            result += sep + jArr[i]['Product']['label'];
                            first = false;
                        }
                    };
                    jQuery('#products-list').html(result);
                }

                if (isQuestDataViewMode() && isHardwareViewMode() && jArr.length > 0) {
                    var supportedProduct = '',
                        supportedOperatingSystems = '',
                        applicableCountriesAndRegions = '',
                        supportedData = '',
                        arrProduct = [],
                        arrPlatform = [];

                    if (isViewModeFull('download')) {
                        supportedProduct = '<h2 class="ibm-h4 ibm-bold">Supported products</h2><h4>Supported systems</h4>';
                        if (typeof jArr[0]['Product']['label'] !== 'undefined' && jArr[0]['Product']['label'] !== null) {
                            supportedProduct += '<ul>';
                        }
                        for (var i in jArr) {
                            if (typeof jArr[i]['Product']['label'] !== 'undefined' && jArr[i]['Product']['label'] !== null) {
                                if (jArr[i]['Product']['label'].split('->').length === 4) {
                                    supportedProduct += '<li>' + jArr[i]['Product']['label'].split('->')[1] + ' (' + jArr[i]['Product']['label'].split('->')[3] + ')</li>';
                                } else if (jArr[i]['Product']['label'].split('->').length === 3) {
                                    supportedProduct += '<li>' + jArr[i]['Product']['label'].split('->')[1] + ' (' + jArr[i]['Product']['label'].split('->')[2] + ')</li>';
                                } else if (jArr[i]['Product']['label'].split('->').length === 2) {
                                    supportedProduct += '<li>' + jArr[i]['Product']['label'].split('->')[1];
                                }
                            }
                        };
                        supportedProduct += '</ul>';

                        // Output "Supported options"
                        supportedProduct += '<h4>Supported options</h4><ul><li>None found</li></ul>';

                        // Output "Supported operating systems"
                        if (jQuery('.field--name-field-operating-system p').length) {
                            jQuery('.field--name-field-operating-system p').each(function () {
                                arrProduct.push(jQuery(this).text().split(':')[0]);
                                arrPlatform.push(jQuery(this).text());
                            });
                            arrProduct = dedup(arrProduct);
                            arrPlatform = dedup(arrPlatform);
                            supportedOperatingSystems = '<h2 class="ibm-h4 ibm-bold">Supported operating systems</h2>';

                            for (var i in arrProduct) {
                                if (typeof arrProduct[i] !== 'undefined' && arrProduct[i] !== null) {
                                    supportedOperatingSystems += '<h4>' + arrProduct[i] + '</h4><ul>';
                                    for (var j in arrPlatform) {
                                        if (arrProduct[i] === arrPlatform[j].split(':')[0]) {
                                            supportedOperatingSystems += '<li>' + arrPlatform[j].split(':')[1] + '</li>';
                                        }
                                    }
                                    supportedOperatingSystems += '</ul>';
                                }
                            }
                        } else {
                            supportedOperatingSystems += '<h4>Operating system independent / None</h4>';
                        }
                    }

                    // Output "Applicable countries and regions"
                    if (jQuery('.field--name-field-document-location p').length) {
                        applicableCountriesAndRegions += '<h2 class="ibm-h4 ibm-bold">Applicable countries and regions</h2><ul>';
                        jQuery('.field--name-field-document-location p').each(function () {
                            applicableCountriesAndRegions += '<li>' + jQuery(this).text() + '</li>';
                        });
                        applicableCountriesAndRegions += '</ul>';
                    }
                    supportedData = supportedProduct + supportedOperatingSystems + applicableCountriesAndRegions;
                    jQuery("#taxonomy-table-list").addClass('ibm-padding-top-1').html(supportedData).show();
                } else {
                    if (jArr.length > 1) {
                        var tableData = '<div class="dblue-table-container"><table class="bx--data-table" data-widget="datatable"><caption><em>Cross-reference information</em></caption><thead><tr>';

                        if (isViewModeFull('notification')) {
                            tableData += '<th scope="col">Risk Classification</th>';
                        }
                        tableData += '<th scope="col">Product</th>';
                        if (!isViewModeFull('contact-reference-file')) {
                            tableData += '<th scope="col">Component</th>';
                            tableData += '<th scope="col">Platform</th>';
                            if (isViewModeFull('system-tip')) {
                                tableData += '<th scope="col">Feature Code</th>';
                                tableData += '<th scope="col">Firmware Level</th>';
                                tableData += '<th scope="col">HMC Level</th>';
                            }
                            tableData += '<th scope="col">Version</th>';
                        }
                        tableData += '</tr></thead><tbody>';

                        //jArr.splice(0, 1); // remove jArr[0]
                        // console.log(jArr);
                        jArr = jArr.sort(function (a, b) {
                            return a.Product.label > b.Product.label ? 1 : -1;
                        });
                        // console.log(jArr);

                        for (var i in jArr) {
                            let armCategoryLabelArr = [],
                                platformLabelArr = [];

                            for (var j in jArr[i]['ARM Category']) {
                                armCategoryLabelArr[j] = jArr[i]['ARM Category'][j]['label'];
                            }
                            for (var j in jArr[i]['Platform']) {
                                platformLabelArr[j] = jArr[i]['Platform'][j]['label'];
                            }

                            tableData += '<tr>';
                            if (isViewModeFull('notification')) {
                                if (typeof jArr[i]['Risk Classification'] !== 'undefined' && jArr[i]['Risk Classification'] !== null) {
                                    tableData += '<td class="ibm-table-row" scope="row">' + jArr[i]['Risk Classification'] + '</td>';
                                } else {
                                    tableData += '<td class="ibm-table-row" scope="row"></td>';
                                }
                            }
                            if (typeof jArr[i]['Product']['label'] !== 'undefined' && jArr[i]['Product']['label'] !== null) {
                                tableData += '<td class="ibm-table-row" scope="row">' + jArr[i]['Product']['label'] + '</td>';
                            } else {
                                tableData += '<td class="ibm-table-row" scope="row"></td>';
                            }
                            if (!isViewModeFull('contact-reference-file')) {
                                if (typeof armCategoryLabelArr !== 'undefined' && armCategoryLabelArr !== null) {
                                    // tableData += '<td>' + jArr[i]['Component'].toString().split(/\s*;\s*/).join(', ') + '</td>';
                                    tableData += '<td>' + armCategoryLabelArr.join(',  ') + '</td>';
                                } else {
                                    tableData += '<td></td>';
                                }
                                if (typeof platformLabelArr !== 'undefined' && platformLabelArr !== null && platformLabelArr.length > 0 && platformLabelArr.filter(Boolean).join('; ').replace('Platform Independent; ', '') !== '') {
                                    tableData += '<td>' + platformLabelArr.filter(Boolean).join('; ').replace('Platform Independent; ', '') + '</td>';
                                } else {
                                    tableData += '<td>Platform Independent</td>';
                                }
                                if (isViewModeFull('system-tip')) {
                                    if (typeof jArr[i]['Feature Code'] !== 'undefined' && jArr[i]['Feature Code'] !== null) {
                                        tableData += '<td>' + jArr[i]['Feature Code'].toString().split(/\s*;\s*/).join(', ') + '</td>';
                                    } else {
                                        tableData += '<td></td>';
                                    }
                                    if (typeof jArr[i]['Firmware Level'] !== 'undefined' && jArr[i]['Firmware Level'] !== null) {
                                        tableData += '<td>' + jArr[i]['Firmware Level'].toString().split(/\s*;\s*/).join(', ') + '</td>';
                                    } else {
                                        tableData += '<td></td>';
                                    }
                                    if (typeof jArr[i]['HMC Level'] !== 'undefined' && jArr[i]['HMC Level'] !== null) {
                                        tableData += '<td>' + jArr[i]['HMC Level'].toString().split(/\s*;\s*/).join(', ') + '</td>';
                                    } else {
                                        tableData += '<td></td>';
                                    }
                                }
                                if (isHardwareViewMode()) {
                                    tableData += '<td></td>';
                                } else {
                                    if (typeof jArr[i]['Version'] !== 'undefined' && jArr[i]['Version'] !== null && jArr[i]['Version'].length > 0) {
                                        tableData += '<td>' + jArr[i]['Version'].toString().split(/\s*;\s*/).join(', ') + '</td>';
                                    } else {
                                        //disdev-1045d tableData += '<td>All Version(s)</td>';
					tableData += '<td>All Versions</td>'; //disdev-1045a
                                    }
	
                                }
                            }
                            tableData += '</tr>';
                        }
                        tableData += '</tbody></table></div>';
                        jQuery("#taxonomy-table-list").addClass('ibm-padding-top-2').html(tableData).show();
                    }
                }
            } else {
                if (isViewModeFull('software-lifecycle') && drupalSettings.myn_subscription_url != ""){
                    var prodCode = jQuery("meta[name='DC.Subject']").attr("content");
                    if(prodCode != ""){
                        let productLabel = jQuery('#block-ibm-carbon-page-title').text().trim().split('_')[0];
                        var subscribe_html = '<div id="ibm-subscribe-section" class="ibm-card"><div class="ibm-card__content" style="padding-top: 20px!important;"><span>Manage My Notification Subscriptions</span><button class="bx--tooltip__trigger bx--tooltip--a11y bx--tooltip--left bx--tooltip--align-start" data-tooltip-icon=""><div class="bx--assistive-text" style="max-width:18rem;"><p>Click the <strong>Subscribe</strong> button to stay informed of critical IBM support updates with My Notifications.<br><br>Take a proactive approach to problem prevention.<br><br>Receive support content tailored to your needs, delivered directly to you!<br><br>Receive immediate notifications of Security Bulletins and Flashes.<br><br>Receive daily or weekly notifications of technical support information such as downloads, tips, technical notes, and publications.</p></div><svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true"><path d="M8.5 11L8.5 6.5 6.5 6.5 6.5 7.5 7.5 7.5 7.5 11 6 11 6 12 10 12 10 11zM8 3.5c-.4 0-.8.3-.8.8S7.6 5 8 5c.4 0 .8-.3.8-.8S8.4 3.5 8 3.5z"></path><path d="M8,15c-3.9,0-7-3.1-7-7s3.1-7,7-7s7,3.1,7,7S11.9,15,8,15z M8,2C4.7,2,2,4.7,2,8s2.7,6,6,6s6-2.7,6-6S11.3,2,8,2z"></path></svg></button><button id="myn_subscribe" class="bx--btn bx--btn--secondary" style="margin-top:20px;" type="button" data-modal-target="#modal-subscribe">Subscribe</button></div></div>';
                        var modal_subscribe_html='<div data-modal id="modal-subscribe" class="bx--modal " role="dialog" aria-modal="true" aria-labelledby="modal-subscribe-label" aria-describedby="modal-subscribe-heading" tabindex="-1"><div class="bx--modal-container bx--modal-container--xs"><div class="bx--modal-header"><p class="bx--modal-header__label bx--type-delta" id="modal-subscribe-label"></p><p class="bx--modal-header__heading bx--type-beta" id="modal-subscribe-heading"></p><button class="bx--modal-close" type="button" data-modal-close aria-label="close modal" id="myn_subscribe_modal_close"><svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" class="bx--modal-close__icon" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true"><path d="M12 4.7L11.3 4 8 7.3 4.7 4 4 4.7 7.3 8 4 11.3 4.7 12 8 8.7 11.3 12 12 11.3 8.7 8z"></path></svg></button></div><div class="bx--modal-content" tabindex="0"><p>You will be taken to the My Notifications interface where you have been auto-subscribed to <strong>'+ productLabel + '</strong></p><p>You can click the EDIT menu option to configure your subscription experience.</p><p>You can also search for and select other IBM products to subscribe to based on your needs.</p></div><div class="bx--modal-content--overflow-indicator"></div><div class="bx--modal-footer"><button class="bx--btn bx--btn--secondary" type="button" data-modal-close>Cancel</button><button id="myn_subscribe_submit" onclick="window.open(\'' + drupalSettings.myn_subscription_url + prodCode + '\',\'_blank\');" class="bx--btn bx--btn--primary" type="button" data-modal-primary-focus>OK</button></div></div><span tabindex="0"></span></div>';
                        var isMyNEnabled=getJsonTopicIdResponse('/support/pages/rest/taxonomy_object/is_product_MyN_enabled/'+prodCode);
                        if(isMyNEnabled==="1") {
                            jQuery('#ibm-document-information').after(subscribe_html);
                            jQuery('#ibm-document-information').after(modal_subscribe_html);
                        }
                        var button_element = document.getElementById("myn_subscribe");
                        if(typeof(button_element) != 'undefined' && button_element != null){
                            var uniqname = getUserLoggedStatus();
                            if(uniqname!==undefined || !drupalSettings.is_rendering_server){
                            } else {
                                button_element.innerText = 'Log in to Subscribe';
                                button_element.onclick = function (e){
                                    setCookie("shouldOpenMynPopup", "true", 1);
                                    document.querySelectorAll("dds-masthead-profile-item")[1].shadowRoot.children[0].click();
                                    e.stopImmediatePropagation();};
                            }
                        }
                    }
                    jQuery(document).on('click', '#myn_subscribe_submit', function(){jQuery("#modal-subscribe").removeClass('is-visible');});
                }   
                let taxonomyInfoData = '';
                if (jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().length) {
                    if (isViewModeFull('software-lifecycle') && jQuery('#block-ibm-carbon-page-title').text().trim().length && jQuery('#block-ibm-carbon-page-title').text().trim().split('_').length - 1 == 1) {
                        let product = jQuery('#block-ibm-carbon-page-title').text().trim().split('_')[0],
                            version = jQuery('#block-ibm-carbon-page-title').text().trim().split('_')[1];
                        version = version.replace(", and future releases", " and future releases"); //dsidev-951a
                        taxonomyInfoData += '<p><strong>More support for: </strong><br>' + product + '</p><p><strong>Software version: </strong><br>' + version + '</p>';
                    }
                    if (isViewModeFull('technical-blog-post')) {
                        console.log(jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text());
                    }
                    if (typeof drupalSettings.nid !== 'undefined') {
                        taxonomyInfoData += '<p><strong>Document number: </strong><br>' + drupalSettings.nid + '</p>';
                    }
                    // if (jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().startsWith('ibm1')) {
                    //     taxonomyInfoData += '<p><strong>Reference #: </strong><br>' + jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().substr(4).replace(/\b(0+)/gi, "") + '</p>';
                    // } else {
                    //     taxonomyInfoData += '<p><strong>Reference #: </strong><br>' + jQuery('.content-field_uid .ibm-northstart-documentation-information-data').text().substr(4) + '</p>';
                    // }
                }
                jQuery('#taxonomy-items').html(taxonomyInfoData);
            }
    }
}

function customPublishedUrlInView() {
    if (jQuery('.ibm-published-url-by-title').length) {
        let linkByTitle = jQuery('.ibm-published-url-by-title').html().trim();
        jQuery('.ibm-published-url-by-title').html('<span><a target="_blank" href="' + linkByTitle + '">' + linkByTitle + '</a></span>');
        if (jQuery('.ibm-published-url-by-id').length) {
            if (linkByTitle.indexOf('/support/pages/') != -1 && linkByTitle.indexOf(jQuery('.ibm-published-url-by-id').html().trim()) == -1) {
                let linkById = linkByTitle.split('/support/pages/')[0] + '/support/pages/node/' + jQuery('.ibm-published-url-by-id').html().trim();
                jQuery('.ibm-published-url-by-id').html('<span><a target="_blank" href="' + linkById + '">' + linkById + '</a></span>').show();
            }
        }
    }
    if (jQuery('.ibm-playbook div').parent().is("div")) {
        jQuery('.ibm-playbook div').unwrap().unwrap().prepend('<b>Additional Help: </b>').addClass('node__meta');
    }
}

function htmlEncode(value) {
    return jQuery('<div/>').text(value).html();
}

function displaySecurityBulletHandler() {
    if (isViewModeFull('security-bullentin')) {
        if (jQuery('#ibm-special-format').text().trim() === 'On') {
            // Enable Special format
            // only display "Summary", "Vulnerability Details", "Workarounds and Mitigations", "Attachment" fields

            jQuery('.field--name-field-affected-products').addClass('field-special-format-true');
            jQuery('.field--name-field-remediation-fixes').addClass('field-special-format-true');
            jQuery('.field--name-field-bluemix').addClass('field-special-format-true');
            jQuery('.field--name-field-bluemix-true-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-bluemix-false-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-zseries').addClass('field-special-format-true');
            jQuery('.field--name-field-zseries-true-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-special-format').addClass('field-special-format-true');
            jQuery('.field--name-field-cvss-v2').addClass('field-special-format-true');
            jQuery('.field--name-field-cvss-v2-true-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-cvss-v3').addClass('field-special-format-true');
            jQuery('.field--name-field-cvss-v3-true-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-reference-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-reference').addClass('field-special-format-true');
            jQuery('.field--name-field-related-information-extra').addClass('field-special-format-true');
            jQuery('.field--name-field-related-information').addClass('field-special-format-true');
            jQuery('.field--name-field-acknowlegement').addClass('field-special-format-true');
            jQuery('.field--name-field-change-history').addClass('field-special-format-true');
            jQuery('.field--name-field-cvss-score').addClass('field-special-format-true');
            jQuery('.field--name-field-disclaimer').addClass('field-special-format-true');
            // jQuery('.field--name-field-historical-number').addClass('field-special-format-true');
            // jQuery('.field--name-field-product-alias').addClass('field-special-format-true');
            jQuery('.field_cvss_score').addClass('field-special-format-true');
            jQuery('.ibm-references-title').addClass('field-special-format-true');
            jQuery('.ibm-references-content').addClass('field-special-format-true');
        }
    }
}

function displayGeneralPageHandler() {
    if (isViewModeFull('general-page')) {
        jQuery('.node--type-general-page h3.ibm-h4.ibm-northstart-product-documentation-title').hide();
        let objString = jQuery('#taxonomy-source').text().trim(),
            jArr = objString.length ? JSON.parse(objString) : [];
        if (drupalSettings.is_rendering_server) {
            if (checkHideDocumentInformationRules(jArr)) {
                jQuery('dds-masthead-l1').hide();
                //jQuery('#ibm-content-body').removeClass('ibm-padding-top-0');
                jQuery('#ibm-document-information, #block-ibm-carbon-page-title, #search-header-wrapper').remove();
                //jQuery('#ibm-drupal-render-page-content').html(jQuery('#block-ibm-carbon-content'));
                jQuery('#block-ibm-carbon-content .field--name-field-body').find('br:last-child').remove();
                jQuery('#block-ibm-carbon-content').find('div').removeClass('content node__content');
                //jQuery('#ibm-drupal-page-content').hide();
                if (jQuery('main').find('#smart-city-container').length) {
                    jQuery('#ibm-content-main').addClass('ibm-background-white-core p-relative');
                }
                if (jQuery('main').find('#ibm-contact-module').length) {
                    jQuery('.drupal-feedback').remove();
                }
            }
        } else {
            if (checkHideDocumentInformationRules(jArr)) {
                jQuery('#com\\.dblue\\.docview\\.body\\.content').removeClass('ibm-col-5-4').removeClass('ibm-col-medium-6-4').addClass('ibm-col-1-1').find('.ibm-card__content').removeClass('ibm-card__content');
                jQuery('#ibm-document-information').hide();
            }
        }
    }
}

function displayDownloadHandler() {
    if (isViewModeFull('download')) {
        jQuery('.field--name-field-download').css("paddingBottom", "15px");
        setTimeout(function () {
            customDownloadableFileView();
        }, 1000);
    }
}

function displayInternalPage() {
    jQuery('.node--type-internal-page h3.ibm-h4.ibm-northstart-product-documentation-title').hide();
}

function checkHideDocumentInformationRules(jArr) {
    return (jArr.length == 0 || (jArr.length >= 1 && typeof jArr[0]['Business Unit']['code'] !== 'undefined' && jArr[0]['Business Unit']['code'] == 'BU023'));
}

function isCorrectBusinessUnits(arr) {
    for (var i in arr) {
        if (typeof arr[i]['Business Unit']['code'] !== 'undefined' && arr[i]['Business Unit']['code'] !== null && arr[i]['Business Unit']['code'].length > 0) {
            return true;
        }
    }
    return false;
}

function fieldDownloadableFileIsEmpty() {
    return (jQuery('.field--name-field-downloadable-file .bx--data-table tbody').text().trim().length == 0);
}

function customDownloadableFileView() {
    if (isHardwareViewMode()) {
        if (fieldDownloadableFileIsEmpty()) {
            jQuery('.field--name-field-downloadable-file, .field--name-field-release-date, .field--name-field-download-version').hide();
        } else {
            jQuery('.field--name-field-downloadable-file h2').text('File details');
            // Move release date section
            if (jQuery('.field--name-field-release-date').length) {
                jQuery('.field--name-field-downloadable-file h2').after(jQuery('.field--name-field-release-date'));
                jQuery('.field--name-field-release-date p').html('<strong>' + jQuery('.field--name-field-release-date h2').text() + ': </strong>' + jQuery('.field--name-field-release-date p').text()).css("paddingBottom", "0");
                jQuery('.field--name-field-release-date h2').remove();
                jQuery('.field--name-field-release-date').show();
            }
            // Move version section
            if (jQuery('.field--name-field-download-version').length) {
                jQuery('.field--name-field-downloadable-file h2').after(jQuery('.field--name-field-download-version'));
                jQuery('.field--name-field-download-version p').html('<strong>' + jQuery('.field--name-field-download-version h2').text() + ': </strong>' + jQuery('.field--name-field-download-version p').text()).css("paddingBottom", "0");
                jQuery('.field--name-field-download-version h2').remove();
                jQuery('.field--name-field-download-version').show();
            }
            jQuery('.field--name-field-downloadable-file').show();
        }
    } else {
        jQuery('.field--name-field-downloadable-file').hide();
    }
}

function customAparNumberInView() {
    if (jQuery('#ibm-apar-number .ibm-item-note').length) {
        jQuery('#ibm-apar-number .ibm-item-note').text(jQuery('#ibm-apar-number .ibm-item-note').text().trim().split(/\s*;\s*/).join(', '));
    }
}

function customProductAliasInView() {
    jQuery('.field--name-field-product-alias .ibm-northstart-documentation-information-data').each(function () {
        if (jQuery(this).text().indexOf(';') != -1) {
            var text = htmlEncode(jQuery(this).text().replace(/\;/g, "<br>"));

            jQuery(this).html(text.replace(/&lt;br&gt;/g, '<br>'));
        }
    });
}

function customHistoricalNumberInView() {
    jQuery('.field--name-field-historical-number .ibm-northstart-documentation-information-data').each(function () {
        if (jQuery(this).text().indexOf(';') != -1) {
            var text = htmlEncode(jQuery(this).text().replace(/\;/g, "<br>"));

            jQuery(this).html(text.replace(/&lt;br&gt;/g, '<br>'));
        }
    });
}

function customRelatedUrlInView() {
    // if (jQuery('article').hasClass('node--type-flashes-alerts') ||
    //     jQuery('article').hasClass('node--type-news') ||
    //     jQuery('article').hasClass('node--type-preventive-service-planning') ||
    //     jQuery('article').hasClass('node--type-product-lifecycle') ||
    //     jQuery('article').hasClass('node--type-fix-readme') ||
    //     jQuery('article').hasClass('node--type-recommended-resources') ||
    //     jQuery('article').hasClass('node--type-question-answer') ||
    //     jQuery('article').hasClass('node--type-troubleshooting') ||
    //     jQuery('article').hasClass('node--type-webcasts') ||
    //     jQuery('article').hasClass('node--type-product-documentation') ||
    //     jQuery('article').hasClass('node--type-manuals') ||
    //     jQuery('article').hasClass('node--type-product-readmes') ||
    //     jQuery('article').hasClass('node--type-detailed-system-requirements') ||
    //     jQuery('article').hasClass('node--type-recommended-resources') ||
    //     jQuery('article').hasClass('node--type-release-notes') ||
    //     jQuery('article').hasClass('node--type-newsletters') ||
    //     jQuery('article').hasClass('node--type-education') ||
    //     jQuery('article').hasClass('node--type-forums-discussion-groups') ||
    //     jQuery('article').hasClass('node--type-white-papers')) {
    jQuery('.field--name-field-related-links .ibm-northstart-documentation-information-label').text('Related Information');
    // }
}

function tooltips(str) {
    if (str.trim().endsWith(',')) {
        str = str.trim().slice(0, -1);
    }
    let strArr = str.replace(/;+jQuery/, '').split(/\s*;\s*/),
        tmp = '',
        j = 3;

    if (strArr.length <= j) {
        tmp = strArr.join(', ');
    } else {
        for (var i in strArr) {
            if (i < j) {
                tmp += strArr[i] + ', ';
            } else if (i == j) {
                if (strArr.length == (i + 1)) {
                    tmp += '<a data-widget="tooltip" title="' + strArr[i];
                } else {
                    tmp += '<a data-widget="tooltip" title="' + strArr[i] + ', ';
                }
            } else {
                if (strArr.length == (i + 1)) {
                    tmp += strArr[i];
                } else {
                    tmp += strArr[i] + ', ';
                }
            }
            if (strArr.length == (i + 1)) {
                tmp += '">More...</a>';
            }
        }
    }
    return tmp.toString();
}

function dedup(arr) {
    var hashTable = {};

    return arr.filter(function (el) {
        var key = JSON.stringify(el),
            match = Boolean(hashTable[key]);

        return (match ? false : hashTable[key] = true);
    });
}

function _dSectionExpand() {
    if (document.getElementById("cSec") !== null && document.getElementById("xSec") !== null) {
        document.getElementById("cSec").style.display = "none";
        document.getElementById("xSec").style.display = "";
    }
}

function _dSectionCollapse() {
    if (document.getElementById("cSec") !== null && document.getElementById("xSec") !== null) {
        document.getElementById("xSec").style.display = "none";
        document.getElementById("cSec").style.display = "";
    }
}

function validateFile(url) {
    var xmlHttp;
    if (window.ActiveXObject) {
        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
    } else if (window.XMLHttpRequest) {
        xmlHttp = new XMLHttpRequest();
    }
    xmlHttp.open("Get", url, false);
    xmlHttp.send();
    if (xmlHttp.status == 404)
        return false;
    else
        return true;
}

function displayProductsSupportDetailsLanding() {
    if(jQuery('#prodDataWrapper').length){
        jQuery.ajax({
            timeout: 100000,
            type: 'GET',
            url: '/support/pages/rest/get_support_details_titles/',
            cache: false,
            async: false,
            success: function (content) {
                var option = '';
                for (var i=0;i<content.length;i++){
                    option += '<option value="'+ content[i] + '">' + content[i] + '</option>';
                }
                jQuery('#support-detail-products').append(option);
                jQuery("#support-detail-products").select2();
            }
        })

        /*
       if(jQuery('.usbl-integrated-button'){
          document.getElementById("usbl-integrated-button").addEventListener("clicl", function(){
       window.usabilla_live("click");
          }
       }); */

        jQuery("#support-detail-products").change(function(){
            //console.log();
            var title=jQuery("#support-detail-products option:selected").text();
            jQuery('.selected-title').remove();
            //console.log(title);
            jQuery.ajax({
                timeout: 100000,
                type: 'GET',
                url: '/support/pages/admin/api/arm_classic?title='+title,
                cache: false,
                async: false,
                success: function (content) {
                if(content[0]){
                    jQuery('.select2').after('<h3 class="ibm-h3 ibm-padding-top-3 selected-title">Support details for '+ title + '</h3>');
                    jQuery.each(content, function (key, data) {
                        jQuery.each(data, function (index, data) {
                            if(data !== ''){
                                jQuery('.' + index + ' .info').html("");
                                jQuery('.' + index + ' .info').append(data);
                                jQuery('.' + index).show();
                            } else {
                                jQuery('.' + index).hide();
                            }
                        })
                    })
                } else {
                        jQuery("#prodDataWrapper div[class^='field_']").hide();
                    }
                } 
            })
        });
    }
}

function prettyPrint() {
    var beforePrint = function() {
         jQuery("#ibm-com").removeAttr("class");
         jQuery('a[href*="_ga"]').each(function() {
            var href = jQuery(this).prop('href');
            jQuery(this).attr("href", href.split('?')[0]);
         });
     };
 
     if (window.matchMedia) {
         var mediaQueryList = window.matchMedia('print');
         mediaQueryList.addListener(function(mql) {
             if (mql.matches) {
                 beforePrint();
             }
         });
     }
     window.onbeforeprint = beforePrint;
 }

function initializeChat() {
    if (drupalSettings.is_rendering_server) {

        if (drupalSettings.isChatAllowedContentType && drupalSettings.isChatAllowedProduct){
            var btn = document.createElement("BUTTON");
            btn.setAttribute("id", "supportChatButton");
            btn.setAttribute("class", "bx--btn bx--btn--primary");
            btn.setAttribute("data-uid", "");
            btn.setAttribute("data-tid", "");
            btn.innerHTML = "Chat with Support";
            document.body.appendChild(btn);
        }

        var element = document.getElementById("supportChatButton");
        if(element){
            jQuery("head link[rel='stylesheet']").last().after("<link rel='stylesheet' href='https://cdnaka2czb2153k0.cdn.appdomain.cloud/v1/salesforce-chatbot.css' type='text/css' media='screen'>");
            jQuery.getScript("https://cdnaka2czb2153k0.cdn.appdomain.cloud/v1/salesforce-chatbot.js");

            var obj=jQuery('#taxonomy-source').text().trim();
            var myJSON = JSON.parse(obj);
            var oc_code=myJSON[0].Product.code;

            element.setAttribute('data-uid', drupalSettings.uid);

            var uid = getUserLoggedStatus();
            if(element.getAttribute('data-uid')==='' || element.getAttribute('data-uid')==='undefined'){
                 element.setAttribute('data-uid', uid);
            }

            var topicID=getJsonTopicIdResponse('/support/pages/rest/taxonomy_object/get_csp_topic_id/'+oc_code);
            if(topicID){
                element.setAttribute('data-tid', topicID);
            }

            setTimeout(function () {
                var uniqname = element.getAttribute('data-uid');
                var uniqtid = element.getAttribute('data-tid');
                if(uniqtid){
                    element.style.display="block";
                    if(uniqname!=='undefined'){
                        //element.onclick = function (){jQuery('#supportChatButton').click()};
                    } else {
                        element.innerText = 'Log in to Chat with Support';
                        //element.disabled = true;
                        //element.onclick = function (){jQuery('.ibm-profile-link').click()};
                        element.onclick = function (){document.querySelectorAll("dds-masthead-profile-item")[1].shadowRoot.children[0].click()};
                    }
                }
            }, 3000);

            jQuery(window).scroll(function() {
                if(jQuery(window).scrollTop() + jQuery(window).height() > jQuery(document).height() - 50) {
                    jQuery('#supportChatButton').addClass('bottom_fixed');
                }else{
                    jQuery('#supportChatButton').removeClass('bottom_fixed');
                }
            });
            element.addEventListener("click",function(){startChatbotConversation('drupal',element.getAttribute('data-uid'),element.getAttribute('data-tid'))});
        }    
    }
}

function getJsonTopicIdResponse(path) {
    var topicId;
    jQuery.ajax({
        type: "GET",
        url: path,
        dataType: 'json',
        async: false,
        success: function(data){
            topicId = data;
        }
    });
    return topicId;
}

function processATMBookmarks(){
    if(jQuery('.node--type-account-details').length || jQuery('.node--type-account-details-proc').length) {
        jQuery(window).on( "load", function() {
            if(window.location.hash) {
                var href = location.hash;
                processAction(href,flag=1);
            }
        });
        jQuery('.ibm-link-list li a').click(function(e) {
            if(jQuery("a[href^='#']")){
                var href = jQuery(this).attr("href");
                window.location.hash = href;
                processAction(href,flag=2);
            }
        })
    
        function processAction (bookmark_id, flag){
            if(jQuery(document).find(".ibm-show-hide .ibm-container-body").is(":visible")){
                jQuery(document).find(".ibm-show-hide .ibm-container-body:not(:first)").hide();
                jQuery(document).find(".ibm-show-hide h2 a:not(:first)").removeClass('ibm-show-active');
                jQuery(document).find("#scrollToTop").remove();
            }
            jQuery(bookmark_id).parents().closest(".ibm-container-body").show();
            jQuery(bookmark_id).parents().closest(".ibm-container-body").prev('h2').children('a').addClass('ibm-show-active');
            jQuery(bookmark_id).next().show();
            if(!jQuery(bookmark_id).next().find("#scrollToTop").length){
                jQuery('<a href="#" id="scrollToTop">Scroll To Top</a>').appendTo(jQuery(bookmark_id).next());
            }
            jQuery(bookmark_id).children('a').addClass('ibm-show-active');
            if(flag==1){
                if(bookmark_id.length){
                jQuery('html, body').animate({scrollTop: jQuery(bookmark_id).offset().top}, 500);
                }
            } else {
                jQuery("#scrollToTop").click(function() {
                    jQuery("html, body").animate({scrollTop: 0}, 500);
                });
            }
        }
    }
}

function ATMExpandCollapseAll(){
    jQuery(function() {
        var headersSign = jQuery('.ibm-show-hide h2 a');
        var contentAreas = jQuery('.ibm-show-hide .ibm-container-body');
        var expandLink = jQuery('.accordion-expand-all');
    
        expandLink.click(function(){
            var isAllOpen = !jQuery(this).data('isAllOpen');
            console.log({isAllOpen: isAllOpen, contentAreas: contentAreas})
            contentAreas[isAllOpen? 'show': 'hide']();
            headersSign[isAllOpen? 'addClass': 'removeClass']('ibm-show-active');
            expandLink.text(isAllOpen? 'Collapse All': 'Expand All').data('isAllOpen', isAllOpen);
        });
    });
}

function getUserLoggedStatus() {
    var user_uid="";
    jQuery.ajax({
         type: "GET",
         url: "https://login.ibm.com/v1/mgmt/idaas/user/status/",
         cache: false,
         async: false,
         crossDomain: true,
         dataType: 'json',
         xhrFields: {
             withCredentials: true
         },
         success: function (data) {
            user_uid = data.uniqueSecurityName;
         }
     });
     return user_uid;
 }

function processMynPopupBehaviour(){
    jQuery(window).on("load", function () {
        var shouldOpenMynPopup = getCookie("shouldOpenMynPopup");
        if (shouldOpenMynPopup != null && shouldOpenMynPopup != "") {
            jQuery("#modal-subscribe").addClass('is-visible');
            jQuery("#modal-subscribe .bx--btn--secondary, #myn_subscribe_modal_close").on("click", function (){jQuery("#modal-subscribe").removeClass('is-visible');})
         }
        deleteCookie("shouldOpenMynPopup");
    })
}